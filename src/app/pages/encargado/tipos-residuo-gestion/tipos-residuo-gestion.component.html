<ion-header class="ek-header">
  <ion-toolbar color="light">
    <ion-title class="title-flex">
      <ion-icon name="recycle-outline"></ion-icon>
      Gestión de residuos
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="openCreate()" [disabled]="creating || updating">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Nuevo tipo
      </ion-button>
      <ion-button fill="clear" (click)="cargarResiduos()">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ek-content">

  <!-- Filtros -->
  <div class="filters-card">
    <div class="filters-grid">
      <ion-item class="filter search" fill="outline">
        <ion-icon name="search-outline" slot="start"></ion-icon>
        <ion-input
          [(ngModel)]="filtroBusqueda"
          placeholder="Buscar por nombre, categoría o unidad"
          clearInput
        ></ion-input>
      </ion-item>

      <ion-item class="filter" fill="outline">
        <ion-icon name="pricetag-outline" slot="start"></ion-icon>
        <ion-select [(ngModel)]="filtroCategoria" placeholder="Categoría" interface="popover">
          <ion-select-option value="">Todas</ion-select-option>
          <ion-select-option *ngFor="let c of categorias" [value]="c">{{ c }}</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item class="filter" fill="outline">
        <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
        <ion-select [(ngModel)]="filtroEstado" placeholder="Estado" interface="popover">
          <ion-select-option value="">Todos</ion-select-option>
          <ion-select-option value="activo">Activos</ion-select-option>
          <ion-select-option value="inactivo">Inactivos</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-button class="filter clear-btn" fill="outline" color="medium" (click)="limpiarFiltros()">
        <ion-icon slot="start" name="close-circle-outline"></ion-icon>
        Limpiar
      </ion-button>
    </div>
  </div>

  <!-- Tabla con paginador -->
  <ion-card class="table-card">
    <ion-card-header class="table-card__header">
      <ion-card-title class="table-card__title">
        <ion-icon name="list-outline"></ion-icon>
        Listado de residuos
      </ion-card-title>
      <div class="table-card__actions">
        <span class="muted">Mostrando {{ pageItems.length }} de {{ residuosFiltrados.length }}</span>
        <ion-select [value]="pageSize" (ionChange)="changePageSize($event.detail.value)" interface="popover">
          <ion-select-option [value]="10">10</ion-select-option>
          <ion-select-option [value]="20">20</ion-select-option>
          <ion-select-option [value]="50">50</ion-select-option>
        </ion-select>
      </div>
    </ion-card-header>

    <ion-card-content class="table-responsive">
      <table class="ek-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Unidad</th>
            <th>Tokens</th>
            <th>Estado</th>
            <th>Actualizado</th>
            <th class="acciones">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of pageItems; trackBy: trackById">
            <td class="bold">{{ r.nombre }}</td>
            <td>{{ r.categoria }}</td>
            <td>{{ r.unidad }}</td>
            <td class="num">{{ r.tokens }}</td>
            <td>
              <ion-badge [color]="r.activo ? 'success' : 'medium'">
                {{ estadoLabel(r) }}
              </ion-badge>
            </td>
            <td class="muted">{{ fechaCorta(r.updatedAt) }}</td>
            <td class="acciones">
              <!-- Solo editar (eliminar removido) -->
              <ion-button size="small" fill="clear" (click)="openEdit(r)" [disabled]="creating || updating" title="Editar">
                <ion-icon name="create-outline"></ion-icon>
              </ion-button>
            </td>
          </tr>

          <tr *ngIf="residuosFiltrados.length === 0">
            <td colspan="7" class="empty">
              <ion-icon name="search-outline"></ion-icon>
              No hay resultados con los filtros actuales.
            </td>
          </tr>
        </tbody>
      </table>
    </ion-card-content>

    <!-- Paginador -->
    <div class="paginator">
      <ion-button fill="clear" [disabled]="pageIndex === 1" (click)="firstPage()">
        <ion-icon name="play-skip-back-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear" [disabled]="pageIndex === 1" (click)="prevPage()">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </ion-button>

      <div class="pages">
        <ng-container *ngFor="let p of pagesToShow(); let i = index">
          <button
            class="page-btn"
            [class.active]="p === pageIndex"
            (click)="goToPage(p)">
            {{ p }}
          </button>
          <span class="dots" *ngIf="i < pagesToShow().length - 1 && pagesToShow()[i+1] - p > 1">…</span>
        </ng-container>
      </div>

      <ion-button fill="clear" [disabled]="pageIndex === totalPages" (click)="nextPage()">
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear" [disabled]="pageIndex === totalPages" (click)="lastPage()">
        <ion-icon name="play-skip-forward-outline"></ion-icon>
      </ion-button>
    </div>
  </ion-card>

  <!-- MODAL: CREAR -->
  <!-- MODAL: CREAR -->
<ion-modal
[isOpen]="isCreateOpen"
(didDismiss)="closeCreate()"
cssClass="ek-modal ek-modal--create"
>
<ng-template>
  <ion-header>
    <ion-toolbar class="ek-modal__toolbar">
      <ion-title class="ek-modal__title">
        <ion-icon name="add-circle-outline"></ion-icon>
        Nuevo tipo de residuo
      </ion-title>
      <ion-buttons slot="end">
        <ion-button fill="clear" color="light" (click)="closeCreate()" aria-label="Cerrar">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>

  <ion-content class="modal-content">
    <form [formGroup]="formCreate" class="ek-form">

      <ion-item fill="outline">
        <ion-label position="stacked">Nombre</ion-label>
        <ion-input formControlName="nombre" placeholder="Ej: Botellas PET"></ion-input>
        <ion-note slot="helper">Máx. 60 caracteres</ion-note>
      </ion-item>

      <ion-item fill="outline">
        <ion-label position="stacked">Descripción</ion-label>
        <ion-textarea formControlName="descripcion" placeholder="Describe el residuo, tips de separación, etc." autoGrow="true"></ion-textarea>
      </ion-item>

      <ion-item fill="outline">
        <ion-label position="stacked">Categoría</ion-label>
        <ion-select formControlName="categoria" interface="popover" placeholder="Selecciona">
          <ion-select-option *ngFor="let c of categorias" [value]="c">{{ c }}</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item fill="outline">
        <ion-label position="stacked">Tipo (opcional)</ion-label>
        <ion-input formControlName="tipo" placeholder="Ej: Plástico PET"></ion-input>
      </ion-item>

      <div class="grid-2">
        <ion-item fill="outline">
          <ion-label position="stacked">Unidad</ion-label>
          <ion-select formControlName="unidad" interface="popover">
            <ion-select-option value="kilos">kilos</ion-select-option>
            <ion-select-option value="gramos">gramos</ion-select-option>
            <ion-select-option value="litros">litros</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item fill="outline">
          <ion-label position="stacked">Tokens por kg</ion-label>
          <ion-input type="number" min="0" step="0.1" formControlName="tokens" placeholder="0"></ion-input>
          <ion-note slot="helper">Incentivo por kilogramo (tokensPorKg)</ion-note>
        </ion-item>
      </div>

      <ion-item lines="none">
        <ion-label>Activo</ion-label>
        <ion-toggle formControlName="activo" color="success"></ion-toggle>
      </ion-item>
    </form>
  </ion-content>

  <ion-footer class="modal-footer">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button fill="outline" (click)="closeCreate()">Cancelar</ion-button>
      </ion-buttons>
      <ion-buttons slot="end">
        <ion-button color="success" [disabled]="formCreate.invalid" (click)="saveCreate()">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Guardar
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-footer>
</ng-template>
</ion-modal>

<!-- MODAL: EDITAR -->
<ion-modal
[isOpen]="isEditOpen"
(didDismiss)="closeEdit()"
cssClass="ek-modal ek-modal--edit"
>
<ng-template>
  <ion-header>
    <ion-toolbar class="ek-modal__toolbar ek-modal__toolbar--edit">
      <ion-title class="ek-modal__title">
        <ion-icon name="create-outline"></ion-icon>
        Editar residuo
      </ion-title>
      <ion-buttons slot="end">
        <ion-button fill="clear" color="light" (click)="closeEdit()" aria-label="Cerrar">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>

  <ion-content class="modal-content">
    <form [formGroup]="formEdit" class="ek-form">

      <ion-item fill="outline">
        <ion-label position="stacked">Nombre</ion-label>
        <ion-input formControlName="nombre"></ion-input>
      </ion-item>

      <ion-item fill="outline">
        <ion-label position="stacked">Descripción</ion-label>
        <ion-textarea formControlName="descripcion" autoGrow="true"></ion-textarea>
      </ion-item>

      <ion-item fill="outline">
        <ion-label position="stacked">Categoría</ion-label>
        <ion-select formControlName="categoria" interface="popover">
          <ion-select-option *ngFor="let c of categorias" [value]="c">{{ c }}</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item fill="outline">
        <ion-label position="stacked">Tipo (opcional)</ion-label>
        <ion-input formControlName="tipo"></ion-input>
      </ion-item>

      <div class="grid-2">
        <ion-item fill="outline">
          <ion-label position="stacked">Unidad</ion-label>
          <ion-select formControlName="unidad" interface="popover">
            <ion-select-option value="kilos">kilos</ion-select-option>
            <ion-select-option value="gramos">gramos</ion-select-option>
            <ion-select-option value="litros">litros</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item fill="outline">
          <ion-label position="stacked">Tokens por kg</ion-label>
          <ion-input type="number" min="0" step="0.1" formControlName="tokens"></ion-input>
          <ion-note slot="helper">Incentivo por kilogramo (tokensPorKg)</ion-note>
        </ion-item>
      </div>

      <ion-item lines="none">
        <ion-label>Activo</ion-label>
        <ion-toggle formControlName="activo" color="success"></ion-toggle>
      </ion-item>
    </form>
  </ion-content>

  <ion-footer class="modal-footer">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button fill="outline" (click)="closeEdit()">Cancelar</ion-button>
      </ion-buttons>
      <ion-buttons slot="end">
        <ion-button color="success" [disabled]="formEdit.invalid" (click)="saveEdit()">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Guardar cambios
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-footer>
</ng-template>
</ion-modal>


</ion-content>
