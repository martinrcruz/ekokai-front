<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Calendario</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- Barra de navegación para el calendario -->
  <div class="calendar-nav">
    <div class="left-buttons">
      <ion-button fill="clear" (click)="previousMonth()">
        <i class="bi bi-arrow-left-circle"></i> Mes
      </ion-button>
    </div>

    <div class="center-display">
      <ion-button class="today-btn" fill="solid" color="danger" (click)="goToday()">Hoy</ion-button>
      <div class="month-year-display">
        {{ viewDate | date: 'MMMM yyyy' }}
      </div>
    </div>

    <div class="right-buttons">
      <ion-button fill="clear" (click)="nextMonth()">
        Mes <i class="bi bi-arrow-right-circle"></i>
      </ion-button>
    </div>
  </div>

  <!-- Calendario mensual -->
  <mwl-calendar-month-view 
    [viewDate]="viewDate"
    [events]="events"
    [refresh]="refresh"
    [cellTemplate]="monthCellTemplate">
  </mwl-calendar-month-view>

  <!-- Template celda calendario (monthCellTemplate) -->
  <ng-template #monthCellTemplate let-day="day">
    <div class="cal-cell" (click)="dayClicked(day)">
      <div class="cal-date">{{ day.date | date:'d' }}</div>
      
      <!-- Mostramos la facturación final en la esquina superior derecha -->
      <div class="fact-sum">
        {{ getFactSum(day.date) }} €
      </div>

      <div class="cal-events">
        <div class="event-icon" *ngFor="let event of day.events" (click)="handleEventClick(event, $event)">
          <img src="assets/icon/extintor.png" alt="extintor" />
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Sección inferior dividida en dos columnas -->
  <ion-grid *ngIf="selectedDay">
    <ion-row>

      <!-- Columna Izquierda: Rutas del día y Detalles -->
      <ion-col size="6">
        <h2>Rutas del {{ selectedDay | date:'dd-MM-yyyy' }}</h2>
        <ion-list>
          <ng-container *ngFor="let r of rutasDelDia">
            <ion-item (click)="toggleRuta(r)" [ngClass]="{'ruta-expanded': rutaSeleccionada === r}">
              <ion-label>
                <h3>{{ r.name?.name || 'Ruta sin nombre' }}</h3>
                <p *ngIf="rutaSeleccionada !== r">{{ r.date }} - {{ r.type }}</p>
                <p *ngIf="rutaSeleccionada === r" style="color: white">{{ r.date }} - {{ r.type }}</p>
              </ion-label>
              <ion-icon slot="end"
                [name]="rutaSeleccionada === r ? 'chevron-up-outline' : 'chevron-down-outline'">
              </ion-icon>
            </ion-item>
      
            <!-- Detalles inmediatamente debajo -->
            <div *ngIf="rutaSeleccionada === r" class="ruta-detalle">
              <h3>{{ r.name?.name || 'Ruta sin nombre' }}</h3>
              <div class="tipo-ruta" [ngClass]="getTipoRutaClass(r.type)">
                {{ r.type }}
              </div>
      
              <div>
                <strong>Vehículo:</strong> {{ r.vehicle?.brand }} - {{ r.vehicle?.matricula }}
              </div>
              <div class="workers-info">
                <strong>Trabajadores:</strong>
                <ion-chip *ngFor="let t of r.users">
                  <ion-label>{{ t.name }}</ion-label>
                </ion-chip>
              </div>
      
              <!-- Partes Asignados -->
              <ion-accordion-group>
                <ion-accordion value="partsAssigned">
                  <ion-item slot="header">
                    <ion-label>Partes Asignados</ion-label>
                  </ion-item>
                  <ion-list slot="content">
                    <ion-item *ngFor="let p of partesAsignadosARuta">
                      <ion-label>{{ p.description }}</ion-label>
                    </ion-item>
                  </ion-list>
                </ion-accordion>
              </ion-accordion-group>
      
              <!-- Botón para habilitar asignación, se oculta si role=worker -->
              <ion-button fill="solid" color="primary" (click)="enableAssignPartes()" *ngIf="!isWorker">
                <ion-icon slot="start" name="checkbox-outline"></ion-icon>
                Asignar Partes
              </ion-button>
            </div>
          </ng-container>
        </ion-list>
      
        <div>
          <p *ngIf="(rutasDelDia?.length || 0) === 0">No existen rutas para este día.</p>
          
          <!-- Botón crear ruta, oculto si role=worker -->
          <ion-button (click)="createRutaParaDia()" *ngIf="!isWorker">
            <ion-icon slot="start" name="add-outline"></ion-icon>
            Crear Ruta
          </ion-button>
        </div>
      </ion-col>
      

      <!-- Columna Derecha: Partes No Asignados + Filtro -->
      <ion-col size="6">
        <h2>Partes No Asignados</h2>
        
        <!-- Filtro (Zona, Tipo, Facturación) -->
        <ion-item>
          <ion-label>Zona</ion-label>
          <ion-select [(ngModel)]="filterZona" placeholder="Todas" (ionChange)="filtrarPartesPendientes()">
            <ion-select-option value="">(Todas)</ion-select-option>
            <ion-select-option *ngFor="let z of zonas" [value]="z._id">
              {{ z.name }}
            </ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item>
          <ion-label>Tipo</ion-label>
          <ion-select [(ngModel)]="filterTipo" placeholder="Todos" (ionChange)="filtrarPartesPendientes()">
            <ion-select-option value="">(Todos)</ion-select-option>
            <ion-select-option value="Obra">Obra</ion-select-option>
            <ion-select-option value="Mantenimiento">Mantenimiento</ion-select-option>
            <ion-select-option value="Correctivo">Correctivo</ion-select-option>
            <ion-select-option value="Visitas">Visitas</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item>
          <ion-label>Facturación</ion-label>
          <ion-select [(ngModel)]="filterFactRange" placeholder="Todos" (ionChange)="filtrarPartesPendientes()">
            <ion-select-option value="">(Todos)</ion-select-option>
            <ion-select-option value="lt100">Menos de 100€</ion-select-option>
            <ion-select-option value="bt100_500">100€ - 500€</ion-select-option>
            <ion-select-option value="gt500">Más de 500€</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-list>
          <ion-item *ngFor="let p of partesNoAsignados">
            <!-- Checkboxes, solo si enableCheckParts y no isWorker -->
            <ion-checkbox slot="start" [(ngModel)]="p.selected" *ngIf="enableCheckParts && !isWorker"></ion-checkbox>
            <ion-label>{{ p.description }} ({{ p.facturacion }} €)</ion-label>
          </ion-item>
        </ion-list>

        <!-- Botón para asignar, si hay una ruta seleccionada y habilitado check, oculto si worker -->
        <ion-button [disabled]="!rutaSeleccionada || !enableCheckParts" 
                    *ngIf="enableCheckParts && !isWorker"
                    (click)="asignarPartesARuta(getSelectedNoAsignados())">
          <ion-icon slot="start" name="checkmark-done-outline"></ion-icon>
          Aceptar Partes Seleccionados
        </ion-button>
      </ion-col>
    </ion-row>
  </ion-grid>

</ion-content>
