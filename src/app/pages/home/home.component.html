<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>
      <img src="assets/icon/reciclar.png" alt="Ekokai" style="height:32px;vertical-align:middle;margin-right:12px;">
      Dashboard Ekokai
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding dashboard-content">
  <div class="dashboard-section dashboard-top-cards">
    <div class="top-card">
      <div class="top-card-icon"><ion-icon name="leaf-outline"></ion-icon></div>
      <div class="top-card-value">{{ totalKilos | number }}</div>
      <div class="top-card-label">Kg reciclados</div>
    </div>
    <div class="top-card">
      <div class="top-card-icon"><ion-icon name="people-outline"></ion-icon></div>
      <div class="top-card-value">{{ totalUsuarios }}</div>
      <div class="top-card-label">Usuarios</div>
    </div>
    <div class="top-card">
      <div class="top-card-icon"><ion-icon name="star-outline"></ion-icon></div>
      <div class="top-card-value">{{ mejorEcopunto.kilosMes }}</div>
      <div class="top-card-label">Mejor Ecopunto</div>
      <div class="top-card-sub">{{ mejorEcopunto.nombre }}</div>
    </div>
    <div class="top-card">
      <div class="top-card-icon"><ion-icon name="star-outline"></ion-icon></div>
      <div class="top-card-value">{{ mejorEcopunto.kilosMes }}</div>
      <div class="top-card-label">Peor Ecopunto</div>
      <div class="top-card-sub">{{ mejorEcopunto.nombre }}</div>
    </div>
  </div>

  <div class="dashboard-section dashboard-graphs-row">
    <div class="graph-card">
      <div class="graph-title">Distribución mensual</div>
      <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="barChartType" [legend]="barChartLegend"></canvas>
      <div class="graph-legend">
        <span class="legend-dot green"></span> Kilos reciclados
      </div>
    </div>
    <div class="graph-card doughnut-card">
      <div class="graph-title">% Meta mensual</div>
      <canvas baseChart [data]="doughnutChartData" [options]="doughnutChartOptions" [type]="doughnutChartType"></canvas>
      <div class="circle-chart-value">
        {{ metaPorcentaje }}%
      </div>
    </div>
  </div>

  <div class="dashboard-section dashboard-table-card">
    <div class="table-tabs">
      <span class="tab active">Usuarios recientes</span>
      <span class="tab">Ecopuntos</span>
      <span class="tab">Más</span>
    </div>
    <ion-card>
      <ion-card-header>
        <ion-card-title>Usuarios recientes ({{ usuariosRecientesFiltrados.length }})</ion-card-title>
        <div class="filtros-section">
          <ion-row>
            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-input 
                  label="Buscar usuario" 
                  labelPlacement="floating"
                  [(ngModel)]="filtroUsuario"
                  (ionInput)="onFiltroUsuarioChange()"
                  placeholder="Nombre o email">
                </ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-select 
                  label="Filtrar por mes" 
                  labelPlacement="floating"
                  [(ngModel)]="filtroMes"
                  (ionChange)="onFiltroMesChange()">
                  <ion-select-option value="">Todos los meses</ion-select-option>
                  <ion-select-option *ngFor="let mes of meses" [value]="mes.value">{{ mes.label }}</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-button fill="clear" (click)="limpiarFiltros()">
                <ion-icon name="refresh-outline" slot="start"></ion-icon>
                Limpiar filtros
              </ion-button>
            </ion-col>
          </ion-row>
        </div>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let user of usuariosRecientesFiltrados; let i = index" class="usuario-item" [class.zebra]="i % 2 === 1">
            <ion-avatar slot="start" [ngClass]="'avatar-' + (user.rol ? user.rol.toLowerCase() : 'default')">
              <span class="avatar-iniciales">
                {{ (user.nombre ? user.nombre[0] : '') + (user.apellido ? user.apellido[0] : '') }}
              </span>
            </ion-avatar>
            <ion-label>
              <h3 class="truncate">{{ user.nombre }} {{ user.apellido }}</h3>
              <p class="usuario-stats">
                <span class="stat" [ngClass]="'rol-' + (user.rol ? user.rol.toLowerCase() : 'default')">{{ user.rol | titlecase }}</span>
                <span class="stat">{{ user.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</span>
              </p>
            </ion-label>
            <ion-buttons slot="end">
              <ion-button fill="clear" (click)="verUsuario(user)" title="Ver usuario">
                <ion-icon name="eye-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" (click)="editarUsuario(user)" title="Editar usuario">
                <ion-icon name="create-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-item>
        </ion-list>
        <div *ngIf="usuariosRecientesFiltrados.length === 0" class="no-data">
          <ion-icon name="people-outline"></ion-icon>
          <p>No hay usuarios que coincidan con los filtros aplicados</p>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>