<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Centro de Reciclaje</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="reciclar-page">

    <!-- Card: Saludo y estadísticas del usuario -->
    <ion-card class="card card-saludo">
      <ion-card-content>
        <div class="saludo-container">
          <div class="saludo-texto">
            <h2>¡Hola, {{ getNombreUsuarioLogueado() }}!</h2>
            <p class="estadistica-dia">
              Hoy has ayudado a reciclar <strong>{{ estadisticasUsuario.kilosHoy | number:'1.0-1' }} kg</strong>.
            </p>
            <p class="meta-info">
              Estás a <strong>{{ estadisticasUsuario.kilosRestantes | number:'1.0-1' }} kg</strong> de cumplir tu meta diaria de <strong>{{ estadisticasUsuario.metaDiaria }} kg</strong>!
            </p>
          </div>
          <div class="meta-progress">
            <ion-progress-bar 
              [value]="estadisticasUsuario.porcentajeMeta / 100"
              [color]="estadisticasUsuario.porcentajeMeta >= 100 ? 'success' : 'primary'">
            </ion-progress-bar>
            <span class="progress-text">{{ estadisticasUsuario.porcentajeMeta | number:'1.0-0' }}%</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Card: Identificación -->
    <ion-card class="card card-id">
      <ion-card-header>
        <ion-card-title>Identificar vecino</ion-card-title>
        <ion-card-subtitle>Ingresa DNI, teléfono o nombre para buscar</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content [formGroup]="formId">
        <div class="grid-3">
          <ion-item>
            <ion-label position="stacked">DNI *</ion-label>
            <ion-input formControlName="dni" placeholder="12345678" type="number"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Teléfono *</ion-label>
            <ion-input formControlName="telefono" placeholder="1123456789" type="tel"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Nombre (opcional)</ion-label>
            <ion-input formControlName="nombre" placeholder="Nombre Apellido"></ion-input>
          </ion-item>
        </div>

        <div class="inline-actions">
          <ion-button 
            (click)="buscarVecino()" 
            [disabled]="buscando || (!formId.value.dni && !formId.value.telefono)"
            color="primary">
            <ion-icon name="search-outline" slot="start"></ion-icon>
            {{ buscando ? 'Buscando...' : 'Buscar vecino' }}
          </ion-button>

          <ion-button 
            (click)="registrarVecinoExpress()" 
            [disabled]="!formId.value.dni || !formId.value.telefono || !formId.value.nombre"
            color="secondary" 
            fill="outline">
            <ion-icon name="person-add-outline" slot="start"></ion-icon>
            Registro express
          </ion-button>

          <ion-button 
            (click)="limpiarBusqueda()" 
            color="medium" 
            fill="clear">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Limpiar
          </ion-button>
        </div>

        <!-- Resultado de búsqueda -->
        <div class="search-result" *ngIf="vecinoSeleccionado">
          <ion-chip color="success" class="chip-encontrado" outline="true">
            <ion-icon name="person-circle-outline"></ion-icon>
            <ion-label>{{ vecinoSeleccionado?.nombre }} {{ vecinoSeleccionado?.apellido }} · {{ vecinoSeleccionado?.telefono }}</ion-label>
          </ion-chip>
        </div>

        <!-- Mensaje de búsqueda fallida -->
        <div class="search-error" *ngIf="busquedaFallida && !vecinoSeleccionado">
          <ion-text color="warning">
            <p>No se encontró ningún vecino con esos datos. Puedes usar "Registro express" para crear uno nuevo.</p>
          </ion-text>
        </div>

        <!-- Error general -->
        <ion-text color="danger" *ngIf="error" class="err">{{ error }}</ion-text>
      </ion-card-content>
    </ion-card>

    <!-- Card: Detalles del reciclaje -->
    <ion-card class="card card-form" [class.locked]="!vecinoSeleccionado">
      <ion-card-header>
        <ion-card-title>Detalles del reciclaje</ion-card-title>
        <ion-card-subtitle *ngIf="!vecinoSeleccionado">Bloqueado hasta validar vecino</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content [formGroup]="formReciclaje">
        <!-- Overlay bloqueo -->
        <div class="lock-overlay" *ngIf="!vecinoSeleccionado">
          <ion-icon name="lock-closed-outline"></ion-icon>
          <span>Valida al vecino para continuar</span>
        </div>

        <div class="grid-2">
          <ion-item class="field">
            <ion-label position="stacked">Tipo de residuo *</ion-label>
            <ion-select formControlName="tipoResiduo" [disabled]="!vecinoSeleccionado" interface="popover"
              placeholder="Selecciona">
              <ion-select-option *ngFor="let t of tiposResiduo" [value]="t._id">{{ t.nombre }}</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item class="field weight-field">
            <ion-label position="stacked">Peso (kg) *</ion-label>
            <ion-input formControlName="pesoKg" readonly placeholder="0.00"></ion-input>
            <ion-button slot="end" (click)="conectarBalanza()" [disabled]="!vecinoSeleccionado || conectando">
              <ion-icon [name]="conectando ? 'sync-outline' : 'hardware-chip-outline'" slot="start"></ion-icon>
              {{ conectando ? 'Conectando...' : 'Obtener peso' }}
            </ion-button>
          </ion-item>
        </div>

        <ion-item class="field">
          <ion-label position="stacked">Descripción (opcional)</ion-label>
          <ion-textarea formControlName="descripcion" placeholder="Detalles adicionales..." rows="2"></ion-textarea>
        </ion-item>

        <div class="meta">
          <ion-badge color="medium" *ngIf="!vecinoSeleccionado">Fecha se asignará al guardar</ion-badge>
          <ion-badge color="success" *ngIf="vecinoSeleccionado">Se guardará con fecha: {{ now | date:'short' }}</ion-badge>
          <ion-badge color="tertiary" *ngIf="formReciclaje.value.pesoKg">Cupones estimados: {{ tokensEstimados() }}</ion-badge>
        </div>

        <ion-button expand="block" shape="round" size="large" (click)="generarCanje()"
          [disabled]="!vecinoSeleccionado || formReciclaje.invalid || canjeando">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          {{ canjeando ? 'Guardando...' : 'Guardar reciclaje' }}
        </ion-button>
      </ion-card-content>
    </ion-card>

  </div>
</ion-content>