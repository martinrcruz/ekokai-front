<ion-header [translucent]="true">
  <ion-toolbar>
    <!-- <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Centro de Reciclaje</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="conectarBalanza()" [disabled]="conectando" fill="clear" class="balance-btn">
        <i class="bi" [class]="conectando ? 'bi-arrow-clockwise' : 'bi-cpu'"></i>
        {{ conectando ? 'Conectando...' : 'Balanza' }}
      </ion-button>
    </ion-buttons> -->
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="reciclar-container">
    <!-- Header de la página -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="bi bi-recycle" style="color: #fff"></i>
        </div>
        <div class="header-text">
          <h1>Centro de Reciclaje</h1>
          <p>Gestiona las entregas de residuos de los vecinos</p>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-number">{{ estadisticasUsuario.kilosHoy | number:'1.0-1' }}</div>
            <div class="stat-label">KG Hoy</div>
          </div>
          <!-- <div class="stat-item">
            <div class="stat-number">{{ estadisticasUsuario.porcentajeMeta | number:'1.0-0' }}%</div>
            <div class="stat-label">Meta</div>
          </div> -->
        </div>
      </div>
    </div>

    <!-- Card: Saludo y estadísticas del usuario -->
    <ion-card class="welcome-card">
      <ion-card-content>
        <div class="welcome-container">
          <div class="welcome-info">
            <div class="welcome-icon">
              <i class="bi bi-person-circle" style="color: #fff"></i>
            </div>
            <div class="welcome-text">
              <h2>¡Hola, {{ getNombreUsuarioLogueado() }}!</h2>
              <p class="stats-today">
                Hoy has ayudado a reciclar <strong>{{ estadisticasUsuario.kilosHoy | number:'1.0-1' }} kg</strong>
              </p>
              <!-- <p class="goal-info">
                Estás a <strong>{{ estadisticasUsuario.kilosRestantes | number:'1.0-1' }} kg</strong> de cumplir tu meta diaria de <strong>{{ estadisticasUsuario.metaDiaria }} kg</strong>!
              </p> -->
            </div>
          </div>
          <div class="goal-progress">
            <!-- <div class="progress-header">
              <span class="progress-label">Progreso diario</span>
              <span class="progress-percentage">{{ estadisticasUsuario.porcentajeMeta | number:'1.0-0' }}%</span>
            </div> -->
            <!-- <ion-progress-bar 
              [value]="estadisticasUsuario.porcentajeMeta / 100"
              [color]="estadisticasUsuario.porcentajeMeta >= 100 ? 'success' : 'primary'"
              class="progress-bar">
            </ion-progress-bar>
            <div class="progress-details">
              <span class="current-kg">{{ estadisticasUsuario.kilosHoy | number:'1.0-1' }} kg</span>
              <span class="goal-kg">Meta: {{ estadisticasUsuario.metaDiaria }} kg</span>
            </div> -->
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Card: Identificación del vecino -->
    <ion-card class="identification-card">
      <ion-card-header>
        <div class="card-header-content">
          <div class="header-icon">
            <i class="bi bi-search" style="color: #fff"></i>
          </div>
          <div class="header-text">
            <ion-card-title>Identificar Vecino</ion-card-title>
            <ion-card-subtitle>Ingresa DNI, teléfono o nombre para buscar</ion-card-subtitle>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content [formGroup]="formId">
        <div class="search-form">
          <div class="form-grid">
            <div class="form-item dni-field">
              <ion-label position="stacked">
                <i class="bi bi-card-text"></i>
                DNI *
              </ion-label>
              <ion-input 
                formControlName="dni" 
                placeholder="12345678" 
                type="number"
                class="search-input">
              </ion-input>
            </div>

            <div class="form-item phone-field">
              <ion-label position="stacked">
                <i class="bi bi-telephone"></i>
                Teléfono *
              </ion-label>
              <ion-input 
                formControlName="telefono" 
                placeholder="1123456789" 
                type="tel"
                class="search-input">
              </ion-input>
            </div>

            <div class="form-item name-field">
              <ion-label position="stacked">
                <i class="bi bi-person"></i>
                Nombre (opcional)
              </ion-label>
              <ion-input 
                formControlName="nombre" 
                placeholder="Nombre Apellido"
                class="search-input">
              </ion-input>
            </div>
          </div>

          <div class="search-actions">
            <ion-button 
              (click)="buscarVecino()" 
              [disabled]="buscando || (!formId.value.dni && !formId.value.telefono)"
              class="search-btn">
              <i class="bi bi-search" slot="start"></i>
              {{ buscando ? 'Buscando...' : 'Buscar Vecino' }}
            </ion-button>

            <!-- <ion-button 
              (click)="abrirModalRegistro()" 
              class="register-btn" 
              fill="outline">
              <i class="bi bi-person-add" slot="start"></i>
              Generar Registro
            </ion-button>
            

            <ion-button 
              (click)="testModal()" 
              color="warning" 
              fill="clear">
              Test Modal
            </ion-button> -->

            <ion-button 
              (click)="limpiarBusqueda()" 
              class="clear-btn" 
              fill="clear">
              <i class="bi bi-arrow-clockwise" slot="start"></i>
              Limpiar
            </ion-button>
          </div>

          <!-- Resultado de búsqueda exitosa -->
          <div class="search-result success" *ngIf="vecinoSeleccionado">
            <div class="result-content">
              <div class="result-icon">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="result-info">
                <h4>Vecino encontrado</h4>
                <p>{{ vecinoSeleccionado?.nombre }} {{ vecinoSeleccionado?.apellido }}</p>
                <span class="result-details">{{ vecinoSeleccionado?.telefono }} · {{ vecinoSeleccionado?.dni }}</span>
              </div>
            </div>
          </div>

          <!-- Mensaje de búsqueda fallida -->
          <div class="search-result warning" *ngIf="busquedaFallida && !vecinoSeleccionado">
            <div class="result-content">
              <div class="result-icon">
                <i class="bi bi-exclamation-triangle"></i>
              </div>
              <div class="result-info">
                <h4>No se encontró el vecino</h4>
                <p>No se encontró ningún vecino con esos datos. Puedes usar "Registro Express" para crear uno nuevo.</p>
              </div>
            </div>
          </div>

          <!-- Error general -->
          <div class="search-result error" *ngIf="error">
            <div class="result-content">
              <div class="result-icon">
                <i class="bi bi-x-circle"></i>
              </div>
              <div class="result-info">
                <h4>Error</h4>
                <p>{{ error }}</p>
              </div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Card: Detalles del reciclaje -->
    <ion-card class="recycling-card" [class.locked]="!vecinoSeleccionado">
      <ion-card-header>
        <div class="card-header-content">
          <div class="header-icon">
            <i class="bi bi-leaf" style="color: #fff"></i>
          </div>
          <div class="header-text">
            <ion-card-title>Detalles del Reciclaje</ion-card-title>
            <ion-card-subtitle *ngIf="!vecinoSeleccionado">Bloqueado hasta validar vecino</ion-card-subtitle>
            <ion-card-subtitle *ngIf="vecinoSeleccionado">Completa los detalles para registrar el reciclaje</ion-card-subtitle>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content [formGroup]="formReciclaje">
        <!-- Overlay de bloqueo -->
        <div class="lock-overlay" *ngIf="!vecinoSeleccionado">
          <div class="lock-content">
            <i class="bi bi-lock-fill"></i>
            <span>Valida al vecino para continuar</span>
          </div>
        </div>

        <div class="recycling-form">
          <div class="form-grid">
            <div class="form-item type-field">
              <ion-label position="stacked">
                <i class="bi bi-trash"></i>
                Tipo de Residuo *
              </ion-label>
              <ion-select 
                formControlName="tipoResiduo" 
                [disabled]="!vecinoSeleccionado" 
                interface="popover"
                placeholder="Selecciona el tipo"
                class="type-select">
                <ion-select-option *ngFor="let t of tiposResiduo" [value]="t._id">
                  {{ t.nombre }}
                </ion-select-option>
              </ion-select>
            </div>

            <div class="form-item weight-field">
              <ion-label position="stacked">
                <i class="bi bi-scale"></i>
                Peso (kg) *
              </ion-label>
              <div class="weight-input-container">
                <ion-input 
                  formControlName="pesoKg" 
                  readonly 
                  placeholder="0.00"
                  class="weight-input">
                </ion-input>
                <ion-button 
                  (click)="conectarBalanza()" 
                  [disabled]="!vecinoSeleccionado || conectando"
                  class="balance-btn-inline">
                  <i class="bi" [class]="conectando ? 'bi-arrow-clockwise' : 'bi-cpu'" slot="start"></i>
                  {{ conectando ? 'Conectando...' : 'Obtener Peso' }}
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Información adicional -->
          <div class="additional-info">
            <div class="info-badges">
              <ion-badge color="medium" *ngIf="!vecinoSeleccionado" class="info-badge">
                <i class="bi bi-clock"></i>
                Fecha se asignará al guardar
              </ion-badge>
              <ion-badge color="success" *ngIf="vecinoSeleccionado" class="info-badge">
                <i class="bi bi-calendar"></i>
                Se guardará con fecha: {{ now | date:'short' }}
              </ion-badge>
              <ion-badge color="tertiary" *ngIf="formReciclaje.value.pesoKg" class="info-badge">
                <i class="bi bi-gift"></i>
                Cupones estimados: {{ tokensEstimados() }}
              </ion-badge>
            </div>
          </div>

          <!-- Botón de guardar -->
          <ion-button 
            expand="block" 
            shape="round" 
            size="large" 
            (click)="generarCanje()"
            [disabled]="!vecinoSeleccionado || formReciclaje.invalid || canjeando"
            class="save-btn">
            <i class="bi bi-save" slot="start"></i>
            {{ canjeando ? 'Guardando...' : 'Guardar Reciclaje' }}
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Modal para registro de vecino -->
  <ion-modal [isOpen]="showRegistroModal" (didDismiss)="cerrarModalRegistro()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="cerrarModalRegistro()" fill="clear" class="close-btn">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title>Registrar Nuevo Vecino</ion-title>
          <ion-buttons slot="end">
            <ion-button 
              (click)="guardarVecino()" 
              [disabled]="guardandoVecino || !formRegistroVecino.valid"
              color="primary">
              <ion-icon name="save-outline" slot="start" *ngIf="!guardandoVecino"></ion-icon>
              <ion-spinner name="crescent" *ngIf="guardandoVecino"></ion-spinner>
              {{ guardandoVecino ? 'Guardando...' : 'Guardar' }}
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="ion-padding">
        <h2>Registrar Nuevo Vecino</h2>
        <p>Completa la información para crear un nuevo vecino</p>
        
        <form [formGroup]="formRegistroVecino">
          <ion-item>
            <ion-label position="stacked">Nombre *</ion-label>
            <ion-input formControlName="nombre" placeholder="Ingresa el nombre"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Apellido *</ion-label>
            <ion-input formControlName="apellido" placeholder="Ingresa el apellido"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">DNI *</ion-label>
            <ion-input formControlName="dni" placeholder="Ingresa el DNI" type="number"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Email *</ion-label>
            <ion-input formControlName="email" type="email" placeholder="ejemplo@email.com"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Teléfono *</ion-label>
            <ion-input formControlName="telefono" placeholder="Ingresa el teléfono" type="tel"></ion-input>
          </ion-item>
        </form>
        
        <!-- Botón de prueba para cerrar -->
        <ion-button expand="block" (click)="cerrarModalRegistro()" color="medium" class="ion-margin-top">
          Cerrar Modal
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>