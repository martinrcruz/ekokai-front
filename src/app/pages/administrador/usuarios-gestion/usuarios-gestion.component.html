<ion-header [translucent]="true">
  <ion-toolbar>
    <!-- <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Gestión de Usuarios</ion-title>
    <ion-buttons slot="end">
    </ion-buttons> -->
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="usuarios-container">
    <!-- Header de la página -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-icon">
          <ion-icon name="people-outline"></ion-icon>
        </div>
        <div class="header-text">
          <h1>Gestión de Usuarios</h1>
          <p>Administra los usuarios del sistema Ekokai</p>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-number">{{ usuariosFiltrados.length }}</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ getUsuariosActivos() }}</div>
            <div class="stat-label">Activos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros estandarizados -->
    <app-filtros-estandarizados
      [filtros]="filtrosConfig"
      titulo="Filtros de Búsqueda"
      subtitulo="Refina los resultados según tus criterios"
      (filtroCambiado)="onFiltroChange($event)"
      (limpiarFiltros)="onLimpiarFiltros()">
    </app-filtros-estandarizados>

    <!-- Card de navegación al módulo de usuarios -->
    <!-- <ion-card class="navigation-card">
      <ion-card-content>
        <div class="navigation-content">
          <div class="navigation-icon">
            <ion-icon name="settings-outline" color="primary"></ion-icon>
          </div>
          <div class="navigation-text">
            <h3>Gestión Avanzada de Usuarios</h3>
            <p>Accede a funcionalidades avanzadas como edición, historial detallado y gestión completa de usuarios</p>
          </div>
          <ion-button 
            (click)="irAModuloUsuarios()" 
            fill="solid" 
            color="primary" 
            class="navigation-btn">
            <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
            Ir al Módulo de Usuarios
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card> -->

    <!-- Card de estadísticas -->
    <!-- <ion-card class="stats-card">
      <ion-card-header>
        <div class="card-header-content">
          <div class="header-icon">
            <ion-icon name="analytics-outline"></ion-icon>
          </div>
          <div class="header-text">
            <ion-card-title>Estadísticas Generales</ion-card-title>
            <ion-card-subtitle>Resumen de usuarios y actividad</ion-card-subtitle>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <div class="stats-grid">
          <div class="stat-item total-users">
            <div class="stat-icon">
              <ion-icon name="people-outline"></ion-icon>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ usuariosFiltrados.length }}</div>
              <div class="stat-label">Total Usuarios</div>
            </div>
          </div>
          
          <div class="stat-item active-users">
            <div class="stat-icon">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ getUsuariosActivos() }}</div>
              <div class="stat-label">Usuarios Activos</div>
            </div>
          </div>
          
          <div class="stat-item total-kilos">
            <div class="stat-icon">
              <ion-icon name="leaf-outline"></ion-icon>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ getTotalKilos() | number:'1.0-0' }}</div>
              <div class="stat-label">KG Reciclados</div>
            </div>
          </div>
          
          <div class="stat-item total-tokens">
            <div class="stat-icon">
              <ion-icon name="gift-outline"></ion-icon>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ getTotalTokens() | number:'1.0-0' }}</div>
              <div class="stat-label">Tokens Totales</div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card> -->

    <!-- Card de lista de usuarios -->
    <ion-card class="usuarios-list-card">
      <ion-card-header>
        <div class="card-header-content">
          <div class="header-icon">
            <ion-icon name="list-outline"></ion-icon>
          </div>
          <div class="header-text">
            <ion-card-title>Lista de Usuarios</ion-card-title>
            <ion-card-subtitle>{{ usuariosFiltrados.length }} usuarios encontrados</ion-card-subtitle>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <!-- Estado de carga -->
        <div *ngIf="loading" class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Cargando usuarios...</p>
        </div>

        <!-- Estado vacío -->
        <div *ngIf="!loading && usuariosFiltrados.length === 0" class="empty-state">
          <div class="empty-content">
            <div class="empty-icon">
              <ion-icon name="people-outline"></ion-icon>
            </div>
            <h3>No hay usuarios</h3>
            <p *ngIf="filtroNombre || filtroRol || filtroEstado">No se encontraron resultados con los filtros aplicados</p>
            <!-- <p *ngIf="!filtroNombre && !filtroRol && !filtroEstado">Crea el primer usuario para comenzar</p>
            <ion-button (click)="crearUsuario('vecino')" class="create-first-btn">
              <ion-icon name="person-add-outline"></ion-icon>
              Crear Primer Usuario
            </ion-button> -->
          </div>
        </div>

        <!-- Lista de usuarios -->
        <div class="usuarios-grid" *ngIf="!loading && usuariosFiltrados.length > 0">
          <ion-card *ngFor="let usuario of usuariosPaginados; let i = index" class="usuario-card">
            <ion-card-content>
              <div class="usuario-header">
                <div class="usuario-avatar">
                  <div class="avatar-initials" [class]="getAvatarClass(usuario.rol)">
                    {{ getIniciales(usuario.nombre, usuario.apellido) }}
                  </div>
                </div>
                
                <div class="usuario-info">
                  <h3 class="usuario-nombre">{{ usuario.nombre }} {{ usuario.apellido }}</h3>
                  <p class="usuario-email">{{ usuario.email }}</p>
                  
                  <div class="usuario-badges">
                    <ion-badge 
                      [class]="getRolBadgeClass(usuario.rol)"
                      class="rol-badge">
                      <ion-icon name="person-circle-outline"></ion-icon>
                      {{ usuario.rol || 'Sin rol' }}
                    </ion-badge>
                    
                    <ion-badge 
                      [class]="usuario.activo ? 'status-active' : 'status-inactive'"
                      class="status-badge">
                      <ion-icon [name]="usuario.activo ? 'checkmark-circle' : 'close-circle'"></ion-icon>
                      {{ usuario.activo ? 'Activo' : 'Inactivo' }}
                    </ion-badge>
                  </div>
                </div>
                
                <div class="usuario-actions">
                  <ion-button 
                    fill="clear" 
                    color="primary" 
                    (click)="verHistorial(usuario)" 
                    title="Ver historial completo"
                    class="action-btn history-btn">
                    <i class="bi bi-clock-history"></i>
                  </ion-button>
                  
                  <ion-button 
                    fill="clear" 
                    color="secondary" 
                    (click)="editarUsuario(usuario)" 
                    title="Editar usuario"
                    class="action-btn edit-btn">
                    <i class="bi bi-pencil-fill"></i>
                  </ion-button>
                  
                  <ion-button 
                    fill="clear" 
                    color="danger" 
                    (click)="eliminarUsuario(usuario)" 
                    title="Eliminar usuario"
                    class="action-btn delete-btn">
                    <i class="bi bi-trash-fill"></i>
                  </ion-button>
                </div>
              </div>
              
              <div class="usuario-stats">
                <div class="stat-item kilos-stat">
                  <ion-icon name="leaf-outline"></ion-icon>
                  <span class="stat-value">{{ usuario.kilosTotal || 0 }}</span>
                  <span class="stat-label">kg reciclados</span>
                </div>
                
                <div class="stat-item tokens-stat">
                  <ion-icon name="gift-outline"></ion-icon>
                  <span class="stat-value">{{ usuario.tokensAcumulados || 0 }}</span>
                  <span class="stat-label">tokens</span>
                </div>
                
                <div class="stat-item dni-stat">
                  <ion-icon name="card-outline"></ion-icon>
                  <span class="stat-value">{{ usuario.dni }}</span>
                  <span class="stat-label">DNI</span>
                </div>
                
                <div class="stat-item phone-stat">
                  <ion-icon name="call-outline"></ion-icon>
                  <span class="stat-value">{{ usuario.telefono }}</span>
                  <span class="stat-label">teléfono</span>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Paginador -->
    <div class="paginador" *ngIf="usuariosFiltrados.length > 0">
      <ion-button 
        size="small" 
        (click)="paginaAnterior()" 
        [disabled]="currentPage === 1"
        class="page-btn prev-btn">
        <ion-icon name="arrow-back-circle-outline"></ion-icon>
        Anterior
      </ion-button>
      
      <span class="pagina-info">
        Página {{ currentPage }} de {{ totalPages }}
      </span>
      
      <ion-button 
        size="small" 
        (click)="paginaSiguiente()" 
        [disabled]="currentPage === totalPages"
        class="page-btn next-btn">
        Siguiente
        <ion-icon name="arrow-forward-circle-outline"></ion-icon>
      </ion-button>
    </div>
  </div>

  <!-- Botón flotante para crear usuario -->
  <button class="floating-action-button" (click)="crearUsuario('vecino')" title="Crear Usuario">
    <i class="bi bi-plus"></i>
  </button>
</ion-content>

<!-- Modal para crear encargado -->
<ion-modal [isOpen]="showCrearEncargadoModal" (didDismiss)="cerrarCrearEncargadoModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cerrarCrearEncargadoModal()" fill="clear" class="close-btn">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Crear Encargado</ion-title>
        <ion-buttons slot="end">
          <ion-button 
            (click)="guardarEncargado()" 
            [disabled]="creandoEncargado || !encargadoFormRef.valid"
            class="save-btn">
            <ion-icon name="save-outline" slot="start" *ngIf="!creandoEncargado"></ion-icon>
            <ion-spinner name="crescent" *ngIf="creandoEncargado"></ion-spinner>
            {{ creandoEncargado ? 'Guardando...' : 'Crear' }}
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-icon">
            <ion-icon name="person-circle-outline"></ion-icon>
          </div>
          <h2>Crear Nuevo Encargado</h2>
          <p>Completa la información para crear un nuevo encargado</p>
        </div>

        <form (ngSubmit)="guardarEncargado()" #encargadoFormRef="ngForm" class="create-form">
          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="person-outline"></ion-icon>
              Nombre *
            </ion-label>
            <ion-input 
              [(ngModel)]="encargadoForm.nombre" 
              name="nombre" 
              required
              placeholder="Ingresa el nombre"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="person-outline"></ion-icon>
              Apellido *
            </ion-label>
            <ion-input 
              [(ngModel)]="encargadoForm.apellido" 
              name="apellido" 
              required
              placeholder="Ingresa el apellido"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="card-outline"></ion-icon>
              DNI *
            </ion-label>
            <ion-input 
              [(ngModel)]="encargadoForm.dni" 
              name="dni" 
              required
              placeholder="Ingresa el DNI"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="mail-outline"></ion-icon>
              Email *
            </ion-label>
            <ion-input 
              [(ngModel)]="encargadoForm.email" 
              name="email" 
              type="email" 
              required
              placeholder="Ingresa el email"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="lock-closed-outline"></ion-icon>
              Contraseña *
            </ion-label>
            <ion-input 
              [(ngModel)]="encargadoForm.password" 
              name="password" 
              type="password" 
              required
              placeholder="Ingresa la contraseña"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="call-outline"></ion-icon>
              Teléfono *
            </ion-label>
            <ion-input 
              [(ngModel)]="encargadoForm.telefono" 
              name="telefono" 
              required
              placeholder="Ingresa el teléfono"
              class="form-input">
            </ion-input>
          </div>
        </form>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para crear vecino -->
<ion-modal [isOpen]="showCrearVecinoModal" (didDismiss)="cerrarCrearVecinoModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cerrarCrearVecinoModal()" fill="clear" class="close-btn">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Crear Vecino</ion-title>
        <ion-buttons slot="end">
          <ion-button 
            (click)="guardarVecino()" 
            [disabled]="creandoVecino || !vecinoFormRef.valid"
            class="save-btn">
            <ion-icon name="save-outline" slot="start" *ngIf="!creandoVecino"></ion-icon>
            <ion-spinner name="crescent" *ngIf="creandoVecino"></ion-spinner>
            {{ creandoVecino ? 'Guardando...' : 'Crear' }}
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-icon">
            <ion-icon name="person-outline"></ion-icon>
          </div>
          <h2>Crear Nuevo Vecino</h2>
          <p>Completa la información para crear un nuevo vecino</p>
        </div>

        <form (ngSubmit)="guardarVecino()" #vecinoFormRef="ngForm" class="create-form">
          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="person-outline"></ion-icon>
              Nombre *
            </ion-label>
            <ion-input 
              [(ngModel)]="vecinoForm.nombre" 
              name="nombre" 
              required
              placeholder="Ingresa el nombre"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="person-outline"></ion-icon>
              Apellido *
            </ion-label>
            <ion-input 
              [(ngModel)]="vecinoForm.apellido" 
              name="apellido" 
              required
              placeholder="Ingresa el apellido"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="card-outline"></ion-icon>
              DNI *
            </ion-label>
            <ion-input 
              [(ngModel)]="vecinoForm.dni" 
              name="dni" 
              required
              placeholder="Ingresa el DNI"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="mail-outline"></ion-icon>
              Email *
            </ion-label>
            <ion-input 
              [(ngModel)]="vecinoForm.email" 
              name="email" 
              type="email" 
              required
              placeholder="Ingresa el email"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="call-outline"></ion-icon>
              Teléfono *
            </ion-label>
            <ion-input 
              [(ngModel)]="vecinoForm.telefono" 
              name="telefono" 
              required
              placeholder="Ingresa el teléfono"
              class="form-input">
            </ion-input>
          </div>
        </form>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para editar usuario -->
<ion-modal [isOpen]="showEditarUsuarioModal" (didDismiss)="cerrarEditarUsuarioModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cerrarEditarUsuarioModal()" fill="clear" class="close-btn">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Editar Usuario</ion-title>
        <ion-buttons slot="end">
          <ion-button 
            (click)="guardarCambiosUsuario()" 
            [disabled]="guardandoCambios || !editarUsuarioFormRef.valid"
            class="save-btn">
            <ion-icon name="checkmark-outline" slot="start" *ngIf="!guardandoCambios"></ion-icon>
            <ion-spinner name="crescent" *ngIf="guardandoCambios"></ion-spinner>
            {{ guardandoCambios ? 'Guardando...' : 'Guardar' }}
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-icon">
            <ion-icon name="create-outline"></ion-icon>
          </div>
          <h2>Editar Información del Usuario</h2>
          <p>Modifica la información del usuario seleccionado</p>
        </div>

        <form (ngSubmit)="guardarCambiosUsuario()" #editarUsuarioFormRef="ngForm" class="edit-form">
          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="person-outline"></ion-icon>
              Nombre *
            </ion-label>
            <ion-input 
              [(ngModel)]="usuarioEditando.nombre" 
              name="nombre" 
              required
              placeholder="Ingresa el nombre"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="person-outline"></ion-icon>
              Apellido *
            </ion-label>
            <ion-input 
              [(ngModel)]="usuarioEditando.apellido" 
              name="apellido" 
              required
              placeholder="Ingresa el apellido"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="card-outline"></ion-icon>
              DNI *
            </ion-label>
            <ion-input 
              [(ngModel)]="usuarioEditando.dni" 
              name="dni" 
              required
              placeholder="Ingresa el DNI"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="call-outline"></ion-icon>
              Teléfono *
            </ion-label>
            <ion-input 
              [(ngModel)]="usuarioEditando.telefono" 
              name="telefono" 
              required
              placeholder="Ingresa el teléfono"
              class="form-input">
            </ion-input>
          </div>

          <div class="form-item">
            <ion-label position="stacked">
              <ion-icon name="mail-outline"></ion-icon>
              Email *
            </ion-label>
            <ion-input 
              [(ngModel)]="usuarioEditando.email" 
              name="email" 
              type="email" 
              required
              placeholder="Ingresa el email"
              class="form-input">
            </ion-input>
          </div>
        </form>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>