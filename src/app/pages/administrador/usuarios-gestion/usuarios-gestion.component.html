<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Gestión de Usuarios</ion-title>
    <ion-buttons slot="end">
      <ion-button id="crearUsuarioBtn" expand="block">
        <ion-icon name="person-add-outline"></ion-icon>
        Crear usuario
      </ion-button>
      <ion-popover trigger="crearUsuarioBtn" triggerAction="click" alignment="end">
        <ng-template>
          <ion-list class="popover-list">
            <ion-item button (click)="crearUsuario('vecino')">
              <ion-icon name="person-outline" slot="start"></ion-icon>
              Crear vecino
            </ion-item>
            <ion-item button (click)="crearUsuario('encargado')">
              <ion-icon name="person-circle-outline" slot="start"></ion-icon>
              Crear encargado
            </ion-item>
          </ion-list>
        </ng-template>
      </ion-popover>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="usuarios-container">

    <!-- Filtros UX/UI moderno -->
    <ion-card class="filters-bar">
      <div class="filters-flex">
        <ion-item lines="none" class="filter-item">
          <ion-icon name="search-outline" slot="start"></ion-icon>
          <ion-input [(ngModel)]="filtroNombre" placeholder="Buscar por nombre o email" clearInput></ion-input>
        </ion-item>
        <ion-item lines="none" class="filter-item">
          <ion-icon name="people-outline" slot="start"></ion-icon>
          <ion-select [(ngModel)]="filtroRol" placeholder="Rol">
            <ion-select-option value="">Todos</ion-select-option>
            <ion-select-option *ngFor="let rol of roles" [value]="rol">{{ rol }}</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item lines="none" class="filter-item">
          <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
          <ion-select [(ngModel)]="filtroEstado" placeholder="Estado">
            <ion-select-option value="">Todos</ion-select-option>
            <ion-select-option *ngFor="let estado of estados" [value]="estado">{{ estado }}</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-button fill="clear" color="medium" class="clear-filters-btn" (click)="limpiarFiltros()">
          <ion-icon name="close-circle-outline"></ion-icon>
          Limpiar
        </ion-button>
      </div>
    </ion-card>

    <!-- Estadísticas rápidas -->
    <!-- <div class="stats-grid">
      <ion-card class="stat-card">
        <ion-card-content>
          <div class="stat-icon bg-primary">
            <ion-icon name="people-outline"></ion-icon>
          </div>
          <div class="stat-info">
            <h3>{{ estadisticas.total }}</h3>
            <p>Total usuarios</p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="stat-card">
        <ion-card-content>
          <div class="stat-icon bg-success">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
          </div>
          <div class="stat-info">
            <h3>{{ estadisticas.activos }}</h3>
            <p>Usuarios activos</p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="stat-card">
        <ion-card-content>
          <div class="stat-icon bg-warning">
            <ion-icon name="leaf-outline"></ion-icon>
          </div>
          <div class="stat-info">
            <h3>{{ estadisticas.totalKilos | number:'1.0-0' }}</h3>
            <p>Kg reciclados</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div> -->

    <!-- Lista de usuarios -->

    <ion-card>
      <ion-card-header>
        <ion-card-title>Usuarios ({{ usuariosFiltrados.length }})</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-card *ngFor="let usuario of usuariosPaginados; let i = index" class="usuario-item">


          <ion-card-content>
            <ion-label>
              <h3 class="truncate">{{ usuario.nombre }} {{ usuario.apellido }}</h3>
              <p class="usuario-stats">
                <span class="stat"
                  [ngClass]="{'rol-admin': usuario.rol === 'administrador', 'rol-encargado': usuario.rol === 'encargado', 'rol-vecino': usuario.rol === 'vecino'}">
                  <strong>Rol: </strong>{{ usuario.rol || 'Sin rol' }}</span>
                  <br>
                <span class="stat" [class.active]="usuario.activo" [class.inactive]="!usuario.activo">
                  <strong>Estado: </strong>{{ usuario.activo ? 'Activo' : 'Inactivo' }}
                </span>
                <br>
                <span class="stat"><strong>Kilos totales: </strong>{{ usuario.kilosTotal || 0 }} kg</span>
                <br>
                <span class="stat"><strong>Cupones: </strong>{{ usuario.tokens || 0 }} tokens</span>
              </p>
            </ion-label>

            <ion-buttons>
              <ion-button fill="clear" color="primary" (click)="verHistorial(usuario)" title="Ver historial completo">
                <ion-icon name="time" size="large"></ion-icon>
                <span class="button-text">Historial</span>
              </ion-button>
              <ion-button fill="clear" color="secondary" (click)="editarUsuario(usuario)" title="Editar usuario">
                <ion-icon name="create" size="large"></ion-icon>
                <span class="button-text">Editar</span>
              </ion-button>
              <!-- <ion-button fill="clear" [color]="usuario.activo ? 'warning' : 'success'" (click)="toggleEstado(usuario)"
                [title]="usuario.activo ? 'Desactivar' : 'Activar'">
                <ion-icon [name]="usuario.activo ? 'pause' : 'play'" size="large"></ion-icon>
                <span class="button-text">{{ usuario.activo ? 'Desactivar' : 'Activar' }}</span>
              </ion-button> -->
              <ion-button fill="clear" color="danger" (click)="eliminarUsuario(usuario)" title="Eliminar usuario">
                <ion-icon name="trash" size="large"></ion-icon>
                <span class="button-text">Eliminar</span>
              </ion-button>
            </ion-buttons>


          </ion-card-content>
        </ion-card>
      </ion-card-content>
    </ion-card>



    <!-- Paginador -->
    <div class="paginador">
      <ion-button size="small" (click)="paginaAnterior()" [disabled]="currentPage === 1">
        <ion-icon name="arrow-back-circle-outline"></ion-icon>
      </ion-button>
      <span class="pagina-info">
        Página {{ currentPage }} de {{ totalPages }}
      </span>
      <ion-button size="small" (click)="paginaSiguiente()" [disabled]="currentPage === totalPages">
        <ion-icon name="arrow-forward-circle-outline"></ion-icon>
      </ion-button>
    </div>
  </div>
</ion-content>

<!-- Modal para crear encargado -->
<ion-modal [isOpen]="showCrearEncargadoModal" (didDismiss)="cerrarCrearEncargadoModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Crear Encargado</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarCrearEncargadoModal()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form (ngSubmit)="guardarEncargado()" #encargadoFormRef="ngForm">
        <ion-item>
          <ion-label position="stacked">Nombre *</ion-label>
          <ion-input [(ngModel)]="encargadoForm.nombre" name="nombre" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Apellido *</ion-label>
          <ion-input [(ngModel)]="encargadoForm.apellido" name="apellido" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">DNI *</ion-label>
          <ion-input [(ngModel)]="encargadoForm.dni" name="dni" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Email *</ion-label>
          <ion-input [(ngModel)]="encargadoForm.email" name="email" type="email" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Contraseña *</ion-label>
          <ion-input [(ngModel)]="encargadoForm.password" name="password" type="password" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Teléfono *</ion-label>
          <ion-input [(ngModel)]="encargadoForm.telefono" name="telefono" required></ion-input>
        </ion-item>
        <div class="modal-actions">
          <ion-button fill="outline" type="button" (click)="cerrarCrearEncargadoModal()" [disabled]="creandoEncargado">
            Cancelar
          </ion-button>
          <ion-button type="submit" color="success" [disabled]="creandoEncargado || !encargadoFormRef.valid">
            <ion-icon name="save-outline" slot="start" *ngIf="!creandoEncargado"></ion-icon>
            <ion-spinner name="crescent" *ngIf="creandoEncargado"></ion-spinner>
            {{ creandoEncargado ? 'Guardando...' : 'Crear Encargado' }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para crear vecino -->
<ion-modal [isOpen]="showCrearVecinoModal" (didDismiss)="cerrarCrearVecinoModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Crear Vecino</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarCrearVecinoModal()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form (ngSubmit)="guardarVecino()" #vecinoFormRef="ngForm">
        <ion-item>
          <ion-label position="stacked">Nombre *</ion-label>
          <ion-input [(ngModel)]="vecinoForm.nombre" name="nombre" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Apellido *</ion-label>
          <ion-input [(ngModel)]="vecinoForm.apellido" name="apellido" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">DNI *</ion-label>
          <ion-input [(ngModel)]="vecinoForm.dni" name="dni" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Email *</ion-label>
          <ion-input [(ngModel)]="vecinoForm.email" name="email" type="email" required></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Teléfono *</ion-label>
          <ion-input [(ngModel)]="vecinoForm.telefono" name="telefono" required></ion-input>
        </ion-item>
        <div class="modal-actions">
          <ion-button fill="outline" type="button" (click)="cerrarCrearVecinoModal()" [disabled]="creandoVecino">
            Cancelar
          </ion-button>
          <ion-button type="submit" color="success" [disabled]="creandoVecino || !vecinoFormRef.valid">
            <ion-icon name="save-outline" slot="start" *ngIf="!creandoVecino"></ion-icon>
            <ion-spinner name="crescent" *ngIf="creandoVecino"></ion-spinner>
            {{ creandoVecino ? 'Guardando...' : 'Crear Vecino' }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>


<!-- Modal para editar usuario -->
<ion-modal [isOpen]="showEditarUsuarioModal" (didDismiss)="cerrarEditarUsuarioModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar color="ekokai-dark">
        <ion-buttons slot="start">
          <!-- Botón de cerrar a la izquierda -->
          <ion-button (click)="cerrarEditarUsuarioModal()" fill="clear" class="close-btn">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Editar Usuario</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="eco-form-content">
      <div class="eco-form-wrapper">
        <p class="eco-form-subtitle">
          Modifica la información del usuario. Todos los campos son obligatorios.
        </p>

        <form (ngSubmit)="guardarCambiosUsuario()" #editarUsuarioFormRef="ngForm" autocomplete="off" class="eco-form">
          <ion-item class="eco-form-item" lines="none">
            <ion-label position="stacked">Nombre</ion-label>
            <ion-input [(ngModel)]="usuarioEditando.nombre" name="nombre" required></ion-input>
          </ion-item>

          <ion-item class="eco-form-item" lines="none">
            <ion-label position="stacked">Apellido</ion-label>
            <ion-input [(ngModel)]="usuarioEditando.apellido" name="apellido" required></ion-input>
          </ion-item>

          <ion-item class="eco-form-item" lines="none">
            <ion-label position="stacked">DNI</ion-label>
            <ion-input [(ngModel)]="usuarioEditando.dni" name="dni" required></ion-input>
          </ion-item>

          <ion-item class="eco-form-item" lines="none">
            <ion-label position="stacked">Teléfono</ion-label>
            <ion-input [(ngModel)]="usuarioEditando.telefono" name="telefono" required></ion-input>
          </ion-item>

          <ion-item class="eco-form-item" lines="none">
            <ion-label position="stacked">Email</ion-label>
            <ion-input [(ngModel)]="usuarioEditando.email" name="email" type="email" required></ion-input>
          </ion-item>

          <div class="eco-form-actions">
            <ion-button expand="block" type="submit" [disabled]="guardandoCambios || !editarUsuarioFormRef.valid"
              class="eco-save-btn">
              <ion-spinner name="crescent" *ngIf="guardandoCambios"></ion-spinner>
              <ng-container *ngIf="!guardandoCambios">Guardar</ng-container>
            </ion-button>

            <ion-button expand="block" color="medium" (click)="cerrarEditarUsuarioModal()" class="eco-cancel-btn">
              Cancelar
            </ion-button>
          </div>
        </form>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>