<ion-header [translucent]="true">
  <ion-toolbar>
    <!-- <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Gestión de Ecopuntos</ion-title>
    <ion-buttons slot="end">
    </ion-buttons> -->
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="ecopuntos-container">
    <!-- Header de la página -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="bi bi-geo-alt" style="color: #fff"></i>
        </div>
        <div class="header-text">
          <h1>Gestión de Ecopuntos</h1>
          <p>Administra los puntos de reciclaje de la comunidad</p>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-number">{{ ecopuntosFiltrados.length }}</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ getEcopuntosActivos() }}</div>
            <div class="stat-label">Activos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros estandarizados -->
    <app-filtros-estandarizados
      [filtros]="filtrosConfig"
      titulo="Filtros de Búsqueda"
      subtitulo="Refina los resultados según tus criterios"
      (filtroCambiado)="onFiltroChange($event)"
      (limpiarFiltros)="onLimpiarFiltros()">
    </app-filtros-estandarizados>

    <!-- Lista de ecopuntos -->
    <ion-card class="ecopuntos-list-card">
      <ion-card-header class="list-header">
        <ion-card-title style="color: white;">
          <i class="bi bi-list-ul"></i>
          Ecopuntos Disponibles
        </ion-card-title>
        <ion-card-subtitle>{{ ecopuntosFiltrados.length }} ecopunto{{ ecopuntosFiltrados.length !== 1 ? 's' : '' }} encontrado{{ ecopuntosFiltrados.length !== 1 ? 's' : '' }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="ecopuntos-grid">
          <ion-card *ngFor="let ecopunto of ecopuntosFiltrados" class="ecopunto-card">
            <ion-card-header class="ecopunto-header">
              <div class="ecopunto-title">
                <i class="bi bi-geo-alt-fill" class="ecopunto-icon"></i>
                <h3>{{ ecopunto.nombre }}</h3>
              </div>
              <ion-badge [color]="ecopunto.activo ? 'success' : 'danger'" class="status-badge">
                <i class="bi" [class]="ecopunto.activo ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
                <span class="badge-text">{{ ecopunto.activo ? 'Activo' : 'Inactivo' }}</span>
              </ion-badge>
            </ion-card-header>
            
            <ion-card-content class="ecopunto-content">
              <div class="ecopunto-info">
                <div class="info-item">
                  <i class="bi bi-compass"></i>
                  <span>{{ ecopunto.direccion }}</span>
                </div>
                
                <div class="info-item">
                  <i class="bi bi-map"></i>
                  <span>{{ ecopunto.zona || 'Sin zona' }}</span>
                </div>
                
                <div class="info-item">
                  <i class="bi bi-clock"></i>
                  <span>{{ ecopunto.horarioApertura || '08:00' }} - {{ ecopunto.horarioCierre || '20:00' }}</span>
                </div>
              </div>

              <div class="ecopunto-stats">
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="bi bi-leaf-fill" style="color:white"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ ecopunto.kilosMes || 0 }}</div>
                    <div class="stat-label">KG Reciclados</div>
                  </div>
                </div>
                
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="bi bi-people-fill" style="color:white"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ ecopunto.usuariosActivos || (ecopunto.vecinos?.length || 0) }}</div>
                    <div class="stat-label">Vecinos Activos</div>
                  </div>
                </div>
                
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="bi bi-archive-fill" style="color:white"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ ecopunto.capacidadMaxima || 1000 }}</div>
                    <div class="stat-label">Capacidad KG</div>
                  </div>
                </div>
              </div>

              <div *ngIf="ecopunto.encargado" class="encargado-info">
                <i class="bi bi-person-check-fill" class="encargado-icon"></i>
                <div class="encargado-details">
                  <span class="encargado-name">{{ ecopunto.encargado.nombre }}</span>
                  <span class="encargado-email" *ngIf="ecopunto.encargado.email">{{ ecopunto.encargado.email }}</span>
                </div>
              </div>

              <div class="ecopunto-actions">
                <ion-button fill="clear" (click)="abrirModalEnrolar(ecopunto)" [disabled]="!ecopunto.activo" class="action-btn enrolar">
                  <i class="bi bi-person-plus-fill"></i>
                  <span class="button-text">Enrolar</span>
                </ion-button>
                
                <ion-button fill="clear" (click)="abrirModalEstadisticas(ecopunto)" class="action-btn stats">
                  <i class="bi bi-graph-up"></i>
                  <span class="button-text">Estadísticas</span>
                </ion-button>
                
                <ion-button fill="clear" (click)="abrirModalMetas(ecopunto)" class="action-btn metas">
                  <i class="bi bi-trophy-fill"></i>
                  <span class="button-text">Metas</span>
                </ion-button>
                
                <ion-button fill="clear" (click)="editarEcopunto(ecopunto)" class="action-btn edit">
                  <i class="bi bi-pencil-fill"></i>
                  <span class="button-text">Editar</span>
                </ion-button>
                
                <ion-button fill="clear" color="danger" (click)="eliminarEcopunto(ecopunto)" class="action-btn delete">
                  <i class="bi bi-trash-fill"></i>
                  <span class="button-text">Eliminar</span>
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Botón flotante para crear ecopunto -->
  <button class="floating-action-button" (click)="crearEcopunto()" title="Crear Ecopunto">
    <i class="bi bi-plus"></i>
  </button>
</ion-content>

<!-- Modal para crear ecopunto -->
<ion-modal [isOpen]="showCreateModal" (didDismiss)="cerrarModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ editMode ? 'Editar Ecopunto' : 'Crear Nuevo Ecopunto' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModal()">
            <i class="bi bi-x-lg"></i>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form (ngSubmit)="guardarEcopunto()" #ecopuntoForm="ngForm">
        <div class="form-section">
          <h3 class="section-title">
            <i class="bi bi-info-circle-fill"></i>
            Información Básica
          </h3>
          
          <ion-item class="form-item">
            <ion-label position="stacked">
              <i class="bi bi-building"></i>
              Nombre del Ecopunto *
            </ion-label>
            <ion-input [(ngModel)]="nuevoEcopunto.nombre" name="nombre" placeholder="Ej: Ecopunto Norte" required class="form-input"></ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-label position="stacked">
              <i class="bi bi-geo-alt-fill"></i>
              Dirección *
            </ion-label>
            <ion-input [(ngModel)]="nuevoEcopunto.direccion" name="direccion" placeholder="Ej: Calle Norte 456, Recoleta" required class="form-input"></ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-label position="stacked">
              <i class="bi bi-map"></i>
              Zona *
            </ion-label>
            <ion-input [(ngModel)]="nuevoEcopunto.zona" name="zona" placeholder="Ej: Norte, Sur, Centro" required class="form-input"></ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-label position="stacked">
              <i class="bi bi-file-text"></i>
              Descripción
            </ion-label>
            <ion-textarea [(ngModel)]="nuevoEcopunto.descripcion" name="descripcion" placeholder="Descripción del ecopunto" rows="3" class="form-textarea"></ion-textarea>
          </ion-item>
        </div>

        <div class="form-section">
          <h3 class="section-title">
            <i class="bi bi-clock"></i>
            Configuración de Horarios
          </h3>
          
          <ion-item class="form-item">
            <ion-label position="stacked">
              <i class="bi bi-sun-fill"></i>
              Horario de Apertura
            </ion-label>
            <ion-input [(ngModel)]="nuevoEcopunto.horarioApertura" name="horarioApertura" type="time" class="form-input"></ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-label position="stacked">
              <i class="bi bi-moon-fill"></i>
              Horario de Cierre
            </ion-label>
            <ion-input [(ngModel)]="nuevoEcopunto.horarioCierre" name="horarioCierre" type="time" class="form-input"></ion-input>
          </ion-item>
        </div>

        <div class="form-section">
          <h3 class="section-title">
            <i class="bi bi-gear-fill"></i>
            Configuración Técnica
          </h3>
          
          <ion-item class="form-item">
            <ion-label position="stacked">
              <i class="bi bi-scale-fill"></i>
              Capacidad Máxima (kg)
            </ion-label>
            <ion-input [(ngModel)]="nuevoEcopunto.capacidadMaxima" name="capacidadMaxima" type="number" placeholder="1000" class="form-input"></ion-input>
          </ion-item>

          <ion-item class="form-item toggle-item">
            <ion-label>
              <div class="toggle-label">
                <i class="bi bi-check-circle-fill"></i>
                <span>Estado Activo</span>
              </div>
              <p>Habilitar el ecopunto para recibir residuos</p>
            </ion-label>
            <ion-toggle [(ngModel)]="nuevoEcopunto.activo" name="activo" class="custom-toggle"></ion-toggle>
          </ion-item>
        </div>

        <div class="modal-actions">
          <ion-button fill="outline" type="button" (click)="cerrarModal()" [disabled]="saving" class="cancel-btn">
            <i class="bi bi-x-lg"></i>
            Cancelar
          </ion-button>
          <ion-button type="submit" color="primary" [disabled]="!ecopuntoForm.valid || saving" class="save-btn">
            <i class="bi bi-check-lg" slot="start" *ngIf="!saving"></i>
            <ion-spinner name="crescent" *ngIf="saving"></ion-spinner>
            {{ saving ? 'Guardando...' : (editMode ? 'Guardar cambios' : 'Crear Ecopunto') }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para enrolar encargado -->
<ion-modal [isOpen]="showEnrolarModal" (didDismiss)="cerrarModalEnrolar()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Asignar Encargado</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalEnrolar()">
            <i class="bi bi-x-lg"></i>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div *ngIf="ecopuntoSeleccionado" class="ecopunto-info">
        <ion-card class="ecopunto-summary">
          <ion-card-header>
            <ion-card-title>
              <i class="bi bi-geo-alt-fill"></i>
              {{ ecopuntoSeleccionado.nombre }}
            </ion-card-title>
            <ion-card-subtitle>{{ ecopuntoSeleccionado.direccion }}</ion-card-subtitle>
          </ion-card-header>
        </ion-card>
      </div>

      <ion-item class="form-item">
        <ion-label position="stacked">
          <i class="bi bi-person"></i>
          Seleccionar Encargado *
        </ion-label>
        <ion-select [(ngModel)]="encargadoSeleccionado" placeholder="Elegir encargado" class="form-select">
          <ion-select-option *ngFor="let encargado of getEncargadosDisponibles()" [value]="encargado._id">
            {{ encargado.nombre }} {{ encargado.apellido }} - {{ encargado.email }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <div class="modal-actions">
        <ion-button fill="outline" type="button" (click)="cerrarModalEnrolar()" [disabled]="enrolando" class="cancel-btn">
          <i class="bi bi-x-lg"></i>
          Cancelar
        </ion-button>
        <ion-button type="button" color="success" (click)="enrolarEncargado()" [disabled]="!encargadoSeleccionado || enrolando || getEncargadosDisponibles().length === 0" class="enrolar-btn">
          <i class="bi bi-person-plus-fill" slot="start" *ngIf="!enrolando"></i>
          <ion-spinner name="crescent" *ngIf="enrolando"></ion-spinner>
          {{ enrolando ? 'Asignando...' : 'Asignar Encargado' }}
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para detalle de ecopunto -->
<ion-modal [isOpen]="showDetalleModal" (didDismiss)="cerrarDetalleModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Detalle del Ecopunto</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarDetalleModal()">
            <i class="bi bi-x-lg"></i>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <ion-card *ngIf="ecopuntoDetalle" class="detail-card">
        <ion-card-header>
          <ion-card-title>
            <i class="bi bi-geo-alt-fill"></i>
            {{ ecopuntoDetalle.nombre }}
          </ion-card-title>
          <ion-card-subtitle>{{ ecopuntoDetalle.direccion }}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="detail-grid">
            <div class="detail-item">
              <i class="bi bi-map"></i>
              <div class="detail-content">
                <span class="detail-label">Zona</span>
                <span class="detail-value">{{ ecopuntoDetalle.zona || 'Sin zona' }}</span>
              </div>
            </div>
            
            <div class="detail-item">
              <i class="bi bi-check-circle-fill"></i>
              <div class="detail-content">
                <span class="detail-label">Estado</span>
                <span class="detail-value">{{ ecopuntoDetalle.activo ? 'Activo' : 'Inactivo' }}</span>
              </div>
            </div>
            
            <div class="detail-item">
              <i class="bi bi-calendar-event"></i>
              <div class="detail-content">
                <span class="detail-label">Fecha de creación</span>
                <span class="detail-value">{{ ecopuntoDetalle.fechaCreacion | date:'medium' }}</span>
              </div>
            </div>
            
            <div class="detail-item">
              <i class="bi bi-person"></i>
              <div class="detail-content">
                <span class="detail-label">Encargado</span>
                <span class="detail-value" *ngIf="ecopuntoDetalle.encargado">{{ ecopuntoDetalle.encargado.nombre }} ({{ ecopuntoDetalle.encargado.email }})</span>
                <span class="detail-value" *ngIf="!ecopuntoDetalle.encargado">Sin encargado</span>
              </div>
            </div>
            
            <div class="detail-item">
              <i class="bi bi-people-fill"></i>
              <div class="detail-content">
                <span class="detail-label">Vecinos registrados</span>
                <span class="detail-value">{{ ecopuntoDetalle.vecinos?.length || 0 }}</span>
              </div>
            </div>
            
            <div class="detail-item" *ngIf="ecopuntoDetalle.descripcion">
              <i class="bi bi-file-text"></i>
              <div class="detail-content">
                <span class="detail-label">Descripción</span>
                <span class="detail-value">{{ ecopuntoDetalle.descripcion }}</span>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para metas mensuales -->
<ion-modal [isOpen]="showMetasModal" (didDismiss)="cerrarModalMetas()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Gestionar Meta Mensual</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalMetas()">
            <i class="bi bi-x-lg"></i>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-card class="meta-header-card">
        <ion-card-header>
          <ion-card-title>
            <i class="bi bi-trophy-fill"></i>
            {{ metasModalData.ecopuntoNombre }}
          </ion-card-title>
          <ion-card-subtitle>Meta para {{ getNombreMes(metasModalData.month - 1) }} {{ metasModalData.year }}</ion-card-subtitle>
        </ion-card-header>
      </ion-card>

      <div class="form-section">
        <h3 class="section-title">
          <i class="bi bi-calendar-event"></i>
          Período de la Meta
        </h3>
        
        <ion-item class="form-item">
          <ion-label position="stacked">
            <i class="bi bi-calendar"></i>
            Año
          </ion-label>
          <ion-input [(ngModel)]="metasModalData.year" type="number" min="2020" max="2030" class="form-input"></ion-input>
        </ion-item>

        <ion-item class="form-item">
          <ion-label position="stacked">
            <i class="bi bi-calendar-event"></i>
            Mes
          </ion-label>
          <ion-select [(ngModel)]="metasModalData.month" class="form-select">
            <ion-select-option *ngFor="let mes of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="mes">
              {{ getNombreMes(mes - 1) }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <div class="form-section">
        <h3 class="section-title">
          <i class="bi bi-scale-fill"></i>
          Objetivo de Reciclaje
        </h3>
        
        <ion-item class="form-item">
          <ion-label position="stacked">
            <i class="bi bi-graph-up"></i>
            Objetivo en KG *
          </ion-label>
          <ion-input [(ngModel)]="metasModalData.objetivoKg" type="number" min="1" placeholder="1000" class="form-input"></ion-input>
        </ion-item>
      </div>

      <div class="modal-actions">
        <ion-button fill="outline" type="button" (click)="cerrarModalMetas()" [disabled]="guardandoMeta" class="cancel-btn">
          <i class="bi bi-x-lg"></i>
          Cancelar
        </ion-button>
        <ion-button type="button" color="danger" (click)="eliminarMeta()" [disabled]="guardandoMeta || !metasModalData.objetivoKg" class="delete-btn">
          <i class="bi bi-trash-fill"></i>
          Eliminar
        </ion-button>
        <ion-button type="button" color="success" (click)="guardarMeta()" [disabled]="!metasModalData.objetivoKg || guardandoMeta" class="save-btn">
          <i class="bi bi-check-lg" slot="start" *ngIf="!guardandoMeta"></i>
          <ion-spinner name="crescent" *ngIf="guardandoMeta"></ion-spinner>
          {{ guardandoMeta ? 'Guardando...' : 'Guardar Meta' }}
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para estadísticas detalladas -->
<ion-modal [isOpen]="showEstadisticasModal" (didDismiss)="cerrarModalEstadisticas()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Estadísticas del Ecopunto</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalEstadisticas()">
            <i class="bi bi-x-lg"></i>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div *ngIf="estadisticasData.ecopunto">
        <ion-card class="ecopunto-summary">
          <ion-card-header>
            <ion-card-title>
              <i class="bi bi-geo-alt-fill"></i>
              {{ estadisticasData.ecopunto.nombre }}
            </ion-card-title>
            <ion-card-subtitle>{{ estadisticasData.ecopunto.direccion }}</ion-card-subtitle>
          </ion-card-header>
        </ion-card>

        <!-- Meta del mes actual -->
        <ion-card *ngIf="estadisticasData.metaMensual?.objetivoKg" class="meta-card">
          <ion-card-header>
            <ion-card-title>
              <i class="bi bi-trophy-fill"></i>
              Meta del Mes Actual
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="meta-progress">
              <div class="meta-info">
                <div class="meta-stat">
                  <span class="meta-label">Objetivo:</span>
                  <span class="meta-value">{{ estadisticasData.metaMensual.objetivoKg }} kg</span>
                </div>
                <div class="meta-stat">
                  <span class="meta-label">Actual:</span>
                  <span class="meta-value">{{ getKilosMesActual() }} kg</span>
                </div>
              </div>
              <ion-progress-bar 
                [value]="getProgresoMetaActual() / 100"
                [color]="getProgresoMetaActual() >= 100 ? 'success' : 'primary'"
                class="progress-bar">
              </ion-progress-bar>
              <span class="progress-text">{{ getProgresoMetaActual() | number:'1.0-0' }}%</span>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Gráfico mensual -->
        <ion-card class="chart-card">
          <ion-card-header>
            <ion-card-title>
              <i class="bi bi-bar-chart-fill"></i>
              Kilos por Mes ({{ getAnioActual() }})
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="chart-container" *ngIf="estadisticasData.kilosMensuales.length > 0">
              <canvas baseChart
                [data]="barChartData"
                [type]="barChartType"
                [options]="barChartOptions">
              </canvas>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Últimas entregas -->
        <ion-card class="entregas-card">
          <ion-card-header>
            <ion-card-title>
              <i class="bi bi-list-ul"></i>
              Últimas Entregas
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list *ngIf="estadisticasData.entregasDetalle.length > 0" class="entregas-list">
              <ion-item *ngFor="let entrega of estadisticasData.entregasDetalle" class="entrega-item">
                <i class="bi bi-person" slot="start" class="entrega-icon"></i>
                <ion-label>
                  <h3 class="entrega-nombre">{{ entrega.vecinoNombre }}</h3>
                  <p class="entrega-details">{{ entrega.fecha | date:'short' }} - {{ entrega.kilos }} kg</p>
                </ion-label>
              </ion-item>
            </ion-list>
            <p *ngIf="estadisticasData.entregasDetalle.length === 0" class="no-entregas">No hay entregas registradas</p>
          </ion-card-content>
        </ion-card>
      </div>

      <div *ngIf="cargandoEstadisticas" class="loading-container">
        <ion-spinner name="crescent" class="loading-spinner"></ion-spinner>
        <p class="loading-text">Cargando estadísticas...</p>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>