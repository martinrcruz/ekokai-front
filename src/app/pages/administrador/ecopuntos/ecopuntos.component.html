<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Gestión de Ecopuntos</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="crearEcopunto()">
        <ion-icon name="add-outline"></ion-icon>
        Nuevo Ecopunto
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="ecopuntos-container">
    <!-- Filtros mejorados -->
    <ion-card class="filters-bar">
      <div class="filters-flex">
        <ion-item lines="none" class="filter-item">
          <ion-icon name="search-outline" slot="start"></ion-icon>
          <ion-input [(ngModel)]="filtroNombre" placeholder="Buscar ecopunto..." clearInput></ion-input>
        </ion-item>

        <ion-item lines="none" class="filter-item">
          <ion-icon name="location-outline" slot="start"></ion-icon>
          <ion-select [(ngModel)]="filtroZona" placeholder="Filtrar por zona">
            <ion-select-option value="">Todas las zonas</ion-select-option>
            <ion-select-option *ngFor="let zona of zonas" [value]="zona">
              {{ zona }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item lines="none" class="filter-item">
          <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
          <ion-select [(ngModel)]="filtroEstado" placeholder="Filtrar por estado">
            <ion-select-option value="">Todos los estados</ion-select-option>
            <ion-select-option value="activo">Activos</ion-select-option>
            <ion-select-option value="inactivo">Inactivos</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-button fill="clear" color="medium" class="clear-filters-btn" (click)="limpiarFiltros()">
          <ion-icon name="close-circle-outline"></ion-icon>
          Limpiar
        </ion-button>
      </div>
    </ion-card>

    <!-- Lista de ecopuntos -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Ecopuntos ({{ ecopuntosFiltrados.length }})</ion-card-title>
      </ion-card-header>
      <ion-card-content>

        <ion-list>

          <ion-card *ngFor="let ecopunto of ecopuntosFiltrados" class="ecopunto-item">
            <ion-card-content>
              <ion-label>
                <div class="ecopunto-header">
                  <h3 class="truncate">{{ ecopunto.nombre }}</h3>
                  <ion-badge [color]="ecopunto.activo ? 'success' : 'danger'">
                    {{ ecopunto.activo ? 'Activo' : 'Inactivo' }}
                  </ion-badge>
                </div>
                <br>
                <p class="truncate">{{ ecopunto.direccion }}</p>
                <p class="ecopunto-stats">
                  <span class="stat"><strong>Reciclado hasta ahora: </strong> {{ ecopunto.kilosMes || 0 }} KG.</span>
                  <br>
                  <span class="stat"><strong>Vecinos Activos: </strong>{{ ecopunto.usuariosActivos ||
                    (ecopunto.vecinos?.length || 0) }} </span>
                  <br>
                  <span class="stat"><strong>Zona: </strong>{{ ecopunto.zona || 'Sin zona' }}</span>
                  <br>
                  <span class="stat"><strong>Horario: </strong>{{ ecopunto.horarioApertura || '08:00' }} - {{ ecopunto.horarioCierre || '20:00' }}</span>
                  <br>
                  <span class="stat"><strong>Capacidad: </strong>{{ ecopunto.capacidadMaxima || 1000 }} kg</span>
                </p>
                <div *ngIf="ecopunto.encargado" class="encargado-asignado">
                  <ion-icon name="person-checkmark-outline"></ion-icon>
                  <span>{{ ecopunto.encargado.nombre }} <span *ngIf="ecopunto.encargado.email">({{
                      ecopunto.encargado.email }})</span></span>
                </div>
              </ion-label>
              <ion-buttons slot="center">
                <ion-button (click)="abrirModalEnrolar(ecopunto)" [disabled]="!ecopunto.activo">
                  <ion-icon name="person-add" size="large"></ion-icon>
                </ion-button>
                <ion-button fill="clear" (click)="abrirModalEstadisticas(ecopunto)">
                  <ion-icon name="analytics" size="large"></ion-icon>
                </ion-button>
                <ion-button fill="clear" (click)="abrirModalMetas(ecopunto)">
                  <ion-icon name="trophy" size="large"></ion-icon>
                </ion-button>
                <ion-button fill="clear" (click)="editarEcopunto(ecopunto)">
                  <ion-icon name="create" size="large"></ion-icon>
                </ion-button>
                <!-- <ion-button fill="clear" [color]="ecopunto.activo ? 'warning' : 'success'" (click)="toggleEstado(ecopunto)">
                  <ion-icon [name]="ecopunto.activo ? 'pause' : 'play'" size="large"></ion-icon>
                  <ion-label>{{ ecopunto.activo ? 'Pausar' : 'Activar' }}</ion-label>
                </ion-button> -->
                <ion-button fill="clear" color="danger" (click)="eliminarEcopunto(ecopunto)">
                  <ion-icon name="trash" size="large"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-card-content>
          </ion-card>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<!-- Modal para crear ecopunto -->
<ion-modal [isOpen]="showCreateModal" (didDismiss)="cerrarModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ editMode ? 'Editar Ecopunto' : 'Crear Nuevo Ecopunto' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModal()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form (ngSubmit)="guardarEcopunto()" #ecopuntoForm="ngForm">
        <ion-item>
          <ion-label position="stacked">Nombre del Ecopunto *</ion-label>
          <ion-input [(ngModel)]="nuevoEcopunto.nombre" name="nombre" placeholder="Ej: Ecopunto Norte" required>
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Dirección *</ion-label>
          <ion-input [(ngModel)]="nuevoEcopunto.direccion" name="direccion" placeholder="Ej: Calle Norte 456, Recoleta"
            required>
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Zona *</ion-label>
          <ion-input [(ngModel)]="nuevoEcopunto.zona" name="zona" placeholder="Ej: Norte, Sur, Centro" required>
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Descripción</ion-label>
          <ion-textarea [(ngModel)]="nuevoEcopunto.descripcion" name="descripcion"
            placeholder="Descripción del ecopunto" rows="3">
          </ion-textarea>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Horario de Apertura</ion-label>
          <ion-input [(ngModel)]="nuevoEcopunto.horarioApertura" name="horarioApertura" type="time">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Horario de Cierre</ion-label>
          <ion-input [(ngModel)]="nuevoEcopunto.horarioCierre" name="horarioCierre" type="time">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Capacidad Máxima (kg)</ion-label>
          <ion-input [(ngModel)]="nuevoEcopunto.capacidadMaxima" name="capacidadMaxima" type="number"
            placeholder="1000">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Estado</ion-label>
          <ion-toggle [(ngModel)]="nuevoEcopunto.activo" name="activo">
            {{ nuevoEcopunto.activo ? 'Activo' : 'Inactivo' }}
          </ion-toggle>
        </ion-item>

        <div class="modal-actions">
          <ion-button fill="outline" type="button" (click)="cerrarModal()" [disabled]="saving">
            Cancelar
          </ion-button>
          <ion-button type="submit" color="primary" [disabled]="!ecopuntoForm.valid || saving">
            <ion-icon name="save-outline" slot="start" *ngIf="!saving"></ion-icon>
            <ion-spinner name="crescent" *ngIf="saving"></ion-spinner>
            {{ saving ? 'Guardando...' : (editMode ? 'Guardar cambios' : 'Crear Ecopunto') }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para enrolar encargado -->
<ion-modal [isOpen]="showEnrolarModal" (didDismiss)="cerrarModalEnrolar()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Enrolar Encargado</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalEnrolar()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div *ngIf="ecopuntoSeleccionado" class="ecopunto-info">
        <ion-card>
          <ion-card-header>
            <ion-card-title>{{ ecopuntoSeleccionado.nombre }}</ion-card-title>
            <ion-card-subtitle>{{ ecopuntoSeleccionado.direccion }}</ion-card-subtitle>
          </ion-card-header>
        </ion-card>
      </div>

      <ion-item>
        <ion-label position="stacked">Seleccionar Encargado *</ion-label>
        <ion-select [(ngModel)]="encargadoSeleccionado" placeholder="Elegir encargado">
          <ion-select-option *ngFor="let encargado of getEncargadosDisponibles()" [value]="encargado._id">
            {{ encargado.nombre }} {{ encargado.apellido }} - {{ encargado.email }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <div class="modal-actions">
        <ion-button fill="outline" type="button" (click)="cerrarModalEnrolar()" [disabled]="enrolando">
          Cancelar
        </ion-button>
        <ion-button type="button" color="success" (click)="enrolarEncargado()"
          [disabled]="!encargadoSeleccionado || enrolando || getEncargadosDisponibles().length === 0">
          <ion-icon name="person-add-outline" slot="start" *ngIf="!enrolando"></ion-icon>
          <ion-spinner name="crescent" *ngIf="enrolando"></ion-spinner>
          {{ enrolando ? 'Enrolando...' : 'Enrolar Encargado' }}
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para detalle de ecopunto -->
<ion-modal [isOpen]="showDetalleModal" (didDismiss)="cerrarDetalleModal()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Detalle del Ecopunto</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarDetalleModal()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <ion-card *ngIf="ecopuntoDetalle">
        <ion-card-header>
          <ion-card-title>{{ ecopuntoDetalle.nombre }}</ion-card-title>
          <ion-card-subtitle>{{ ecopuntoDetalle.direccion }}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <p><strong>Zona:</strong> {{ ecopuntoDetalle.zona || 'Sin zona' }}</p>
          <p><strong>Activo:</strong> {{ ecopuntoDetalle.activo ? 'Sí' : 'No' }}</p>
          <p><strong>Fecha de creación:</strong> {{ ecopuntoDetalle.fechaCreacion | date:'medium' }}</p>
          <p><strong>Encargado:</strong> <span *ngIf="ecopuntoDetalle.encargado">{{ ecopuntoDetalle.encargado.nombre }}
              ({{ ecopuntoDetalle.encargado.email }})</span><span *ngIf="!ecopuntoDetalle.encargado">Sin
              encargado</span></p>
          <p><strong>Vecinos:</strong> {{ ecopuntoDetalle.vecinos?.length || 0 }}</p>
          <p *ngIf="ecopuntoDetalle.descripcion"><strong>Descripción:</strong> {{ ecopuntoDetalle.descripcion }}</p>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para metas mensuales -->
<ion-modal [isOpen]="showMetasModal" (didDismiss)="cerrarModalMetas()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Gestionar Meta Mensual</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalMetas()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ metasModalData.ecopuntoNombre }}</ion-card-title>
          <ion-card-subtitle>Meta para {{ getNombreMes(metasModalData.month - 1) }} {{ metasModalData.year }}</ion-card-subtitle>
        </ion-card-header>
      </ion-card>

      <ion-item>
        <ion-label position="stacked">Año</ion-label>
        <ion-input [(ngModel)]="metasModalData.year" type="number" min="2020" max="2030"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Mes</ion-label>
        <ion-select [(ngModel)]="metasModalData.month">
          <ion-select-option *ngFor="let mes of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="mes">
            {{ getNombreMes(mes - 1) }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Objetivo en KG *</ion-label>
        <ion-input [(ngModel)]="metasModalData.objetivoKg" type="number" min="1" placeholder="1000"></ion-input>
      </ion-item>

      <div class="modal-actions">
        <ion-button fill="outline" type="button" (click)="cerrarModalMetas()" [disabled]="guardandoMeta">
          Cancelar
        </ion-button>
        <ion-button type="button" color="danger" (click)="eliminarMeta()" [disabled]="guardandoMeta || !metasModalData.objetivoKg">
          <ion-icon name="trash-outline" slot="start"></ion-icon>
          Eliminar
        </ion-button>
        <ion-button type="button" color="success" (click)="guardarMeta()" [disabled]="!metasModalData.objetivoKg || guardandoMeta">
          <ion-icon name="save-outline" slot="start" *ngIf="!guardandoMeta"></ion-icon>
          <ion-spinner name="crescent" *ngIf="guardandoMeta"></ion-spinner>
          {{ guardandoMeta ? 'Guardando...' : 'Guardar Meta' }}
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para estadísticas detalladas -->
<ion-modal [isOpen]="showEstadisticasModal" (didDismiss)="cerrarModalEstadisticas()" [presentingElement]="null">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Estadísticas del Ecopunto</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalEstadisticas()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div *ngIf="estadisticasData.ecopunto">
        <ion-card>
          <ion-card-header>
            <ion-card-title>{{ estadisticasData.ecopunto.nombre }}</ion-card-title>
            <ion-card-subtitle>{{ estadisticasData.ecopunto.direccion }}</ion-card-subtitle>
          </ion-card-header>
        </ion-card>

        <!-- Meta del mes actual -->
        <ion-card *ngIf="estadisticasData.metaMensual?.objetivoKg">
          <ion-card-header>
            <ion-card-title>Meta del Mes Actual</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="meta-progress">
                             <div class="meta-info">
                 <span><strong>Objetivo:</strong> {{ estadisticasData.metaMensual.objetivoKg }} kg</span>
                 <span><strong>Actual:</strong> {{ getKilosMesActual() }} kg</span>
               </div>
               <ion-progress-bar 
                 [value]="getProgresoMetaActual() / 100"
                 [color]="getProgresoMetaActual() >= 100 ? 'success' : 'primary'">
               </ion-progress-bar>
               <span class="progress-text">{{ getProgresoMetaActual() | number:'1.0-0' }}%</span>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Gráfico mensual -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Kilos por Mes ({{ getAnioActual() }})</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="chart-container" *ngIf="estadisticasData.kilosMensuales.length > 0">
              <canvas baseChart
                [data]="barChartData"
                [type]="barChartType"
                [options]="barChartOptions">
              </canvas>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Últimas entregas -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Últimas Entregas</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list *ngIf="estadisticasData.entregasDetalle.length > 0">
              <ion-item *ngFor="let entrega of estadisticasData.entregasDetalle">
                <ion-label>
                  <h3>{{ entrega.vecinoNombre }}</h3>
                  <p>{{ entrega.fecha | date:'short' }} - {{ entrega.kilos }} kg</p>
                </ion-label>
              </ion-item>
            </ion-list>
            <p *ngIf="estadisticasData.entregasDetalle.length === 0">No hay entregas registradas</p>
          </ion-card-content>
        </ion-card>
      </div>

      <div *ngIf="cargandoEstadisticas" class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Cargando estadísticas...</p>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>