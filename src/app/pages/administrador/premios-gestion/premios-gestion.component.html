<ion-header [translucent]="true">
  <ion-toolbar>
    <!-- <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Gestión de Premios</ion-title>
    <ion-buttons slot="end">
    </ion-buttons> -->
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="premios-container">
    <!-- Header de la página -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="bi bi-gift" style="color: #fff"></i>
        </div>
        <div class="header-text">
          <h1>Gestión de Premios</h1>
          <p>Administra el catálogo de premios disponibles para canjear</p>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-number">{{ premiosFiltrados.length }}</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ getPremiosActivos() }}</div>
            <div class="stat-label">Activos</div>
          </div>
        </div>
      </div>
      
      <!-- Botón para agregar premio - CENTRADO Y ANCHO COMPLETO -->
      <div class="header-actions">
        <ion-button (click)="abrirCrearModal()" style="--background: #2d5016; --color: white;" fill="solid" class="add-button">
          <ion-icon name="gift-outline" slot="start"></ion-icon>
          Agregar Premio
        </ion-button>
      </div>
    </div>

    <!-- Pestanas principales -->
    <ion-segment [(ngModel)]="pestanaActiva" (ionChange)="cambiarPestana($event.detail.value?.toString())" class="main-segment">
      <ion-segment-button value="premios" class="segment-btn">
        <i class="bi bi-gift-fill"></i>
        <ion-label>Premios</ion-label>
      </ion-segment-button>
      <ion-segment-button value="estadisticas" class="segment-btn">
        <i class="bi bi-graph-up"></i>
        <ion-label>Estadísticas</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Pestana de Premios -->
    <div *ngIf="pestanaActiva === 'premios'" class="premios-tab">
      <!-- Filtros estandarizados -->
      <app-filtros-estandarizados
        [filtros]="filtrosConfig"
        titulo="Filtros de Búsqueda"
        subtitulo="Refina los resultados según tus criterios"
        (filtroCambiado)="onFiltroChange($event)"
        (limpiarFiltros)="onLimpiarFiltros()">
      </app-filtros-estandarizados>

      <!-- Lista de premios -->
      <ion-card class="premios-list-card">
        <ion-card-header class="list-header">
          <ion-card-title style="color: white;">
            <i class="bi bi-list-ul"></i>
            Catálogo de Premios
          </ion-card-title>
          <ion-card-subtitle>{{ premiosFiltrados.length }} premio{{ premiosFiltrados.length !== 1 ? 's' : '' }} encontrado{{ premiosFiltrados.length !== 1 ? 's' : '' }}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="premios-grid">
            <ion-card *ngFor="let premio of premiosFiltrados" class="premio-card">
              <ion-card-header class="premio-header">
                <div class="premio-image-container">
                  <img [src]="getImagenPremio(premio)" [alt]="premio.nombre" class="premio-imagen">
                  <div class="premio-status-overlay">
                    <ion-badge [color]="getActivoColor(premio.activo)" class="status-badge">
                      <i class="bi bi-check-circle-fill" *ngIf="premio.activo"></i>
                      <i class="bi bi-x-circle-fill" *ngIf="!premio.activo"></i>
                      {{ premio.activo ? 'Activo' : 'Inactivo' }}
                    </ion-badge>
                  </div>
                </div>
                
                <div class="premio-info">
                  <h3 class="premio-nombre">{{ premio.nombre }}</h3>
                  <p class="premio-descripcion">{{ premio.descripcion }}</p>
                  
                  <div class="premio-badges">
                    <ion-badge [color]="getCategoriaColor(premio.categoria)" class="categoria-badge">
                      <i class="bi bi-tag"></i>
                      {{ premio.categoria }}
                    </ion-badge>
                    
                    <ion-badge [color]="getDestacadoColor(premio.destacado)" class="destacado-badge" *ngIf="premio.destacado">
                      <i class="bi bi-star"></i>
                      Destacado
                    </ion-badge>
                  </div>
                </div>
              </ion-card-header>
              
              <ion-card-content class="premio-content">
                <div class="premio-stats">
                  <div class="stat-item">
                    <i class="bi bi-card-text"></i>
                    <div class="stat-content">
                      <span class="stat-label">Cupones</span>
                      <span class="stat-value">{{ premio.cuponesRequeridos }}</span>
                    </div>
                  </div>
                  
                  <div class="stat-item">
                    <i class="bi bi-box"></i>
                    <div class="stat-content">
                      <span class="stat-label">Stock</span>
                      <span class="stat-value">{{ premio.stock }}</span>
                    </div>
                  </div>
                  
                  <div class="stat-item">
                    <i class="bi bi-list"></i>
                    <div class="stat-content">
                      <span class="stat-label">Orden</span>
                      <span class="stat-value">{{ premio.orden }}</span>
                    </div>
                  </div>
                  
                  <div class="stat-item">
                    <i class="bi bi-calendar"></i>
                    <div class="stat-content">
                      <span class="stat-label">Creado</span>
                      <span class="stat-value">{{ premio.createdAt | date:'shortDate' }}</span>
                    </div>
                  </div>
                </div>

                <div class="premio-actions">
                  <ion-button fill="clear" (click)="abrirEditarModal(premio)" class="action-btn edit">
                    <i class="bi bi-pencil"></i>
                    <span>Editar</span>
                  </ion-button>
                  
                  <ion-button fill="clear" color="danger" (click)="eliminarPremio(premio)" class="action-btn delete">
                    <i class="bi bi-trash"></i>
                    <span>Eliminar</span>
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Pestana de Estadísticas -->
    <div *ngIf="pestanaActiva === 'estadisticas'" class="estadisticas-tab">
      <!-- Resumen general -->
      <ion-card class="summary-card">
        <ion-card-header class="summary-header">
          <ion-card-title style="color: white;">
            <i class="bi bi-graph-up"></i>
            Resumen General
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-icon">
                <i class="bi bi-gift"></i>
              </div>
              <div class="summary-content">
                <div class="summary-value">{{ estadisticas.totalPremios || 0 }}</div>
                <div class="summary-label">Total Premios</div>
              </div>
            </div>
            
            <div class="summary-item">
              <div class="summary-icon">
                <i class="bi bi-check-circle-fill"></i>
              </div>
              <div class="summary-content">
                <div class="summary-value">{{ getPremiosActivos() }}</div>
                <div class="summary-label">Premios Activos</div>
              </div>
            </div>
            
            <div class="summary-item">
              <div class="summary-icon">
                <i class="bi bi-star"></i>
              </div>
              <div class="summary-content">
                <div class="summary-value">{{ getPremiosDestacados() }}</div>
                <div class="summary-label">Premios Destacados</div>
              </div>
            </div>
            
            <div class="summary-item">
              <div class="summary-icon">
                <i class="bi bi-tag"></i>
              </div>
              <div class="summary-content">
                <div class="summary-value">{{ estadisticas.categorias?.length || 0 }}</div>
                <div class="summary-label">Categorías</div>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Distribución por categorías -->
      <ion-card class="categorias-card">
        <ion-card-header class="categorias-header">
          <ion-card-title style="color: white;">
            <i class="bi bi-pie-chart"></i>
            Distribución por Categorías
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="categorias-list">
            <div *ngFor="let categoria of estadisticas.categorias" class="categoria-item">
              <div class="categoria-info">
                <i class="bi bi-tag" class="categoria-icon"></i>
                <span class="categoria-nombre">{{ categoria }}</span>
              </div>
              <div class="categoria-count">
                {{ getPremiosPorCategoria(categoria) }} premios
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Top premios más caros -->
      <ion-card class="top-premios-card">
        <ion-card-header class="top-header">
          <ion-card-title style="color: white;">
            <i class="bi bi-trophy"></i>
            Top Premios por Cupones
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="top-premios-list">
            <div *ngFor="let premio of getTopPremios(); let i = index" class="top-premio-item">
              <div class="premio-rank">
                <i [class]="getRankIcon(i + 1)"></i>
                <span class="rank-number">{{ i + 1 }}</span>
              </div>
              <div class="premio-info">
                <img [src]="getImagenPremio(premio)" [alt]="premio.nombre" class="premio-thumbnail">
                <div class="premio-details">
                  <span class="premio-nombre">{{ premio.nombre }}</span>
                  <span class="premio-cupones">{{ premio.cuponesRequeridos }} cupones</span>
                </div>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Botón flotante para crear premio -->
  <button class="floating-action-button" (click)="abrirCrearModal()" title="Crear Premio">
    <i class="bi bi-plus"></i>
  </button>
</ion-content>

<!-- Modal de Crear Premio -->
<ion-modal [isOpen]="showCrearModal" (didDismiss)="cerrarCrearModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Crear Nuevo Premio</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarCrearModal()">
            <i class="bi bi-x-lg"></i>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form (ngSubmit)="crearPremio()">
        <ion-item>
          <ion-label position="stacked">Nombre *</ion-label>
          <ion-input [(ngModel)]="premioForm.nombre" name="nombre" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Descripción *</ion-label>
          <ion-textarea [(ngModel)]="premioForm.descripcion" name="descripcion" rows="3" required></ion-textarea>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Cupones Requeridos *</ion-label>
          <ion-input [(ngModel)]="premioForm.cuponesRequeridos" name="cuponesRequeridos" type="number" min="0" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Stock *</ion-label>
          <ion-input [(ngModel)]="premioForm.stock" name="stock" type="number" min="0" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Categoría *</ion-label>
          <ion-input [(ngModel)]="premioForm.categoria" name="categoria" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Orden</ion-label>
          <ion-input [(ngModel)]="premioForm.orden" name="orden" type="number" min="0"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-checkbox [(ngModel)]="premioForm.activo" name="activo"></ion-checkbox>
          <ion-label>Activo</ion-label>
        </ion-item>
        
        <ion-item>
          <ion-checkbox [(ngModel)]="premioForm.destacado" name="destacado"></ion-checkbox>
          <ion-label>Destacado</ion-label>
        </ion-item>
        
        <div class="modal-actions">
          <ion-button type="submit" [disabled]="guardando" expand="block">
            <i class="bi bi-save" *ngIf="!guardando"></i>
            <ion-spinner *ngIf="guardando"></ion-spinner>
            {{ guardando ? 'Guardando...' : 'Crear Premio' }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal de Editar Premio -->
<ion-modal [isOpen]="showEditarModal" (didDismiss)="cerrarEditarModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Editar Premio</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarEditarModal()">
            <i class="bi bi-x-lg"></i>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form (ngSubmit)="guardarEdicion()" *ngIf="premioEditando">
        <ion-item>
          <ion-label position="stacked">Nombre *</ion-label>
          <ion-input [(ngModel)]="premioEditando.nombre" name="nombre" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Descripción *</ion-label>
          <ion-textarea [(ngModel)]="premioEditando.descripcion" name="descripcion" rows="3" required></ion-textarea>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Cupones Requeridos *</ion-label>
          <ion-input [(ngModel)]="premioEditando.cuponesRequeridos" name="cuponesRequeridos" type="number" min="0" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Stock *</ion-label>
          <ion-input [(ngModel)]="premioEditando.stock" name="stock" type="number" min="0" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Categoría *</ion-label>
          <ion-input [(ngModel)]="premioEditando.categoria" name="categoria" required></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Orden</ion-label>
          <ion-input [(ngModel)]="premioEditando.orden" name="orden" type="number" min="0"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-checkbox [(ngModel)]="premioEditando.activo" name="activo"></ion-checkbox>
          <ion-label>Activo</ion-label>
        </ion-item>
        
        <ion-item>
          <ion-checkbox [(ngModel)]="premioEditando.destacado" name="destacado"></ion-checkbox>
          <ion-label>Destacado</ion-label>
        </ion-item>
        
        <div class="modal-actions">
          <ion-button type="submit" [disabled]="guardando" expand="block">
            <i class="bi bi-save" *ngIf="!guardando"></i>
            <ion-spinner *ngIf="guardando"></ion-spinner>
            {{ guardando ? 'Guardando...' : 'Guardar Cambios' }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>