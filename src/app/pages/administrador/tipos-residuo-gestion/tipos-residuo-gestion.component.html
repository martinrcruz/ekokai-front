<ion-header [translucent]="true">
  <ion-toolbar>
    <!-- <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title class="page-title">Gestión de Tipos de Residuo</ion-title>
    <ion-buttons slot="end">
    </ion-buttons> -->
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="tipos-residuo-container">
    <!-- Header de la página -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="bi bi-leaf" style="color: #fff"></i>
        </div>
        <div class="header-text">
          <h1>Gestión de Tipos de Residuo</h1>
          <p>Administra los diferentes tipos de residuos reciclables</p>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-number">{{ residuos.length }}</div>
            <div class="stat-label">Total</div>
          </div>
          <!-- <div class="stat-item">
            <div class="stat-number">{{ promedioTokens | number:'1.0-1' }}</div>
            <div class="stat-label">Promedio</div>
          </div> -->
        </div>
      </div>
      
      <!-- Botón para agregar tipo de residuo - CENTRADO Y ANCHO COMPLETO -->
      <div class="header-actions">
        <ion-button (click)="abrirCrearModal()" style="--background: #2d5016; --color: white;" fill="solid" class="add-button">
          <ion-icon name="leaf-outline" slot="start"></ion-icon>
          Agregar Tipo de Residuo
        </ion-button>
      </div>
    </div>

    <!-- Filtros estandarizados -->
    <app-filtros-estandarizados
      [filtros]="filtrosConfig"
      titulo="Filtros de Búsqueda"
      subtitulo="Refina los resultados según tus criterios"
      (filtroCambiado)="onFiltroChange($event)"
      (limpiarFiltros)="onLimpiarFiltros()">
    </app-filtros-estandarizados>

    <!-- Card de estadísticas -->
    <!-- <ion-card class="stats-card">
      <ion-card-header>
        <div class="card-header-content">
          <div class="header-icon">
            <ion-icon name="analytics-outline"></ion-icon>
          </div>
          <div class="header-text">
            <ion-card-title>Estadísticas Generales</ion-card-title>
            <ion-card-subtitle>Resumen de los tipos de residuo</ion-card-subtitle>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <div class="stats-grid">
          <div class="stat-item total-types">
            <div class="stat-icon">
              <ion-icon name="leaf-outline"></ion-icon>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ residuos.length }}</div>
              <div class="stat-label">Tipos de Residuo</div>
            </div>
          </div>
          
          <div class="stat-item avg-tokens">
            <div class="stat-icon">
              <ion-icon name="trending-up-outline"></ion-icon>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ promedioTokens | number:'1.0-1' }}</div>
              <div class="stat-label">Promedio Tokens/kg</div>
            </div>
          </div>
          
          <div class="stat-item max-tokens">
            <div class="stat-icon">
              <ion-icon name="star-outline"></ion-icon>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ maxTokens }}</div>
              <div class="stat-label">Máximo Tokens/kg</div>
            </div>
          </div>
          
          <div class="stat-item filtered-count">
            <div class="stat-icon">
              <ion-icon name="filter-outline"></ion-icon>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ residuosFiltrados.length }}</div>
              <div class="stat-label">Resultados Filtrados</div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card> -->

    <!-- Card de lista de tipos de residuo -->
    <ion-card class="residuos-list-card">
      <ion-card-header>
        <div class="card-header-content">
          <div class="header-icon">
            <i class="bi bi-list" style="color: #fff"></i>
          </div>
          <div class="header-text">
            <ion-card-title>Tipos de Residuo</ion-card-title>
            <ion-card-subtitle>{{ residuosFiltrados.length }} de {{ residuos.length }} tipos</ion-card-subtitle>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <!-- Estado de carga -->
        <div *ngIf="loading" class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Cargando tipos de residuo...</p>
        </div>

        <!-- Estado vacío -->
        <div *ngIf="!loading && residuosFiltrados.length === 0" class="empty-state">
          <div class="empty-content">
            <div class="empty-icon">
              <i class="bi bi-leaf-fill" style="color:white"></i>
            </div>
            <h3>No hay tipos de residuo</h3>
            <p *ngIf="filtroNombre || filtroTokens">No se encontraron resultados con los filtros aplicados</p>
            <!-- <p *ngIf="!filtroNombre && !filtroTokens">Crea el primer tipo de residuo para comenzar</p> -->
            <!-- <ion-button (click)="abrirCrearModal()" class="create-first-btn">
              <i class="bi bi-plus-circle-fill" style="color:white"></i>
              <span class="button-text">Crear Primer Tipo</span>
            </ion-button> -->
          </div>
        </div>

        <!-- Lista de residuos -->
        <div class="residuos-grid" *ngIf="!loading && residuosFiltrados.length > 0">
          <ion-card *ngFor="let residuo of residuosFiltrados" class="residuo-card">
            <ion-card-content>
              <div class="residuo-header">
                <div class="residuo-icon">
                  <i class="bi bi-leaf-fill" style="color:white"></i>
                </div>
                <div class="residuo-info">
                  <h3 class="residuo-nombre">{{ residuo.nombre }}</h3>
                  <p class="residuo-descripcion">{{ residuo.descripcion }}</p>
                </div>
                <div class="residuo-actions">
                  <ion-button fill="clear" (click)="editarResiduo(residuo)" class="edit-btn" title="Editar">
                    <i class="bi bi-pencil-square"></i>
                  </ion-button>
                  <ion-button fill="clear" color="danger" (click)="eliminarResiduo(residuo)" [disabled]="eliminando" class="delete-btn" title="Eliminar">
                    <i class="bi bi-trash"></i>
                    <ion-spinner name="crescent" *ngIf="eliminando"></ion-spinner>
                  </ion-button>
                </div>
              </div>
              
              <div class="residuo-stats">
                <div class="stat-item tokens-stat">
                  <i class="bi bi-trending-up"></i>
                  <span class="stat-value">{{ residuo.tokensPorKg }}</span>
                  <span class="stat-label">tokens/kg</span>
                </div>
                <div class="stat-item category-stat" [class]="getTokenCategory(residuo.tokensPorKg)">
                  <i class="bi bi-tag"></i>
                  <span class="stat-value">{{ getTokenCategory(residuo.tokensPorKg) }}</span>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Modal de edición -->
    <ion-modal [isOpen]="showEditarModal" (didDismiss)="cerrarEditarModal()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-buttons slot="start">
              <ion-button (click)="cancelarEdicion()" fill="clear" class="close-btn">
                <i class="bi bi-x-lg"></i>
              </ion-button>
            </ion-buttons>
            <ion-title>Editar Tipo de Residuo</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="guardarEdicion()" [disabled]="guardando" class="save-btn">
                <i class="bi bi-check-lg" *ngIf="!guardando"></i>
                <ion-spinner name="crescent" *ngIf="guardando"></ion-spinner>
                <span class="button-text">{{ guardando ? 'Guardando...' : 'Guardar' }}</span>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        
        <ion-content>
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-icon">
                <i class="bi bi-pencil-square"></i>
              </div>
              <h2>Editar Información del Residuo</h2>
              <p>Modifica los datos del tipo de residuo seleccionado</p>
            </div>

            <form (ngSubmit)="guardarEdicion()" class="edit-form">
              <div class="form-item">
                <ion-label position="stacked">
                  <i class="bi bi-leaf-fill"></i>
                  <span class="label-text">Nombre del Residuo *</span>
                </ion-label>
                <ion-input 
                  [(ngModel)]="residuoEditando.nombre" 
                  name="nombre" 
                  required
                  placeholder="Ej: Plástico PET"
                  class="form-input">
                </ion-input>
              </div>

              <div class="form-item">
                <ion-label position="stacked">
                  <i class="bi bi-file-text"></i>
                  <span class="label-text">Descripción *</span>
                </ion-label>
                <ion-textarea 
                  [(ngModel)]="residuoEditando.descripcion" 
                  name="descripcion" 
                  required
                  placeholder="Describe el tipo de residuo" 
                  rows="3"
                  class="form-textarea">
                </ion-textarea>
              </div>

              <div class="form-item">
                <ion-label position="stacked">
                  <i class="bi bi-trending-up"></i>
                  <span class="label-text">Tokens por Kilogramo *</span>
                </ion-label>
                <ion-input 
                  type="number" 
                  [(ngModel)]="residuoEditando.tokensPorKg" 
                  name="tokensPorKg" 
                  required 
                  min="0"
                  step="0.1" 
                  placeholder="Ej: 15.5"
                  class="form-input">
                </ion-input>
                <ion-note slot="helper">
                  <i class="bi bi-info-circle"></i>
                  <span class="note-text">Ingresa cuántos tokens se otorgan por kilogramo de este residuo</span>
                </ion-note>
              </div>
            </form>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- Modal de creación -->
    <ion-modal [isOpen]="showCrearModal" (didDismiss)="cancelarCreacion()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-buttons slot="start">
              <ion-button (click)="cancelarCreacion()" fill="clear" class="close-btn">
                <i class="bi bi-x-lg"></i>
              </ion-button>
            </ion-buttons>
            <ion-title>Nuevo Tipo de Residuo</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="crearResiduo()" [disabled]="guardando" class="create-btn">
                <i class="bi bi-plus-lg" *ngIf="!guardando"></i>
                <ion-spinner name="crescent" *ngIf="guardando"></ion-spinner>
                <span class="button-text">{{ guardando ? 'Creando...' : 'Crear' }}</span>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        
        <ion-content>
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-icon">
                <i class="bi bi-plus-circle-fill"></i>
              </div>
              <h2>Crear Nuevo Tipo de Residuo</h2>
              <p>Define un nuevo tipo de residuo reciclable</p>
            </div>

            <form (ngSubmit)="crearResiduo()" class="create-form">
              <div class="form-item">
                <ion-label position="stacked">
                  <i class="bi bi-leaf-fill"></i>
                  <span class="label-text">Nombre *</span>
                </ion-label>
                <ion-input 
                  [(ngModel)]="nuevoResiduo.nombre" 
                  name="nombre" 
                  required
                  placeholder="Ej: Plástico PET"
                  class="form-input">
                </ion-input>
              </div>

              <div class="form-item">
                <ion-label position="stacked">
                  <i class="bi bi-file-text"></i>
                  <span class="label-text">Descripción *</span>
                </ion-label>
                <ion-textarea 
                  [(ngModel)]="nuevoResiduo.descripcion" 
                  name="descripcion" 
                  required
                  placeholder="Describe el tipo de residuo" 
                  rows="3"
                  class="form-textarea">
                </ion-textarea>
              </div>

              <div class="form-item">
                <ion-label position="stacked">
                  <i class="bi bi-trending-up"></i>
                  <span class="label-text">Tokens por Kilogramo *</span>
                </ion-label>
                <ion-input 
                  type="number" 
                  [(ngModel)]="nuevoResiduo.tokensPorKg" 
                  name="tokensPorKg" 
                  required 
                  min="0"
                  step="0.1" 
                  placeholder="Ej: 15.5"
                  class="form-input">
                </ion-input>
                <ion-note slot="helper">
                  <i class="bi bi-info-circle"></i>
                  <span class="note-text">Define cuántos tokens se otorgan por kilogramo de este residuo</span>
                </ion-note>
              </div>
            </form>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>
  </div>

  <!-- Botón flotante para crear tipo de residuo -->
  <button class="floating-action-button" (click)="abrirCrearModal()" title="Crear Tipo de Residuo">
    <i class="bi bi-plus"></i>
  </button>
</ion-content>