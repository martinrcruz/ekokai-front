<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Rutas</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="nuevaRuta()">
        <ion-icon name="add-circle-outline" style="color: white !important"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content style="--overflow: visible;">
  <!-- Buscador -->
  <ion-searchbar 
    (ionInput)="filtrar($event)" 
    placeholder="Buscar ruta" 
    showCancelButton="focus">
  </ion-searchbar>

  <!-- Refresher -->
  <ion-refresher (ionRefresh)="cargarRutas()">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Contenedor que forzará scroll horizontal si es necesario -->
  <div class="table-wrapper">
    <ion-grid>
      <!-- Encabezado de columnas -->
      <ion-row class="header-row">
        <ion-col class="td-center"><strong>Nombre</strong></ion-col>
        <ion-col class="td-center"><strong>Fecha</strong></ion-col>
        <ion-col class="td-center"><strong>Tipo</strong></ion-col>
        <ion-col class="td-center"><strong>Estado</strong></ion-col>
        <ion-col class="td-center"><strong>Vehículo</strong></ion-col>
        <ion-col class="td-center"><strong>Trabajadores</strong></ion-col>
        <ion-col class="td-center" size="2"><strong>Acciones</strong></ion-col>
      </ion-row>

      <!-- Filas de datos -->
      <ion-row *ngFor="let r of filteredRutas">
        <!-- Nombre (objeto con .name o string) -->
        <ion-col class="td-center">
          {{ r.name?.name || r.name }}
        </ion-col>

        <!-- Fecha (DD-MM-YYYY) -->
        <ion-col class="td-center">
          {{ r.date | date:'dd-MM-yyyy' }}
        </ion-col>

        <!-- Tipo (con color) -->
        <ion-col class="td-center">
          <p class="tipo-ruta" [ngClass]="getTipoRutaClass(r.type)">
            {{ r.type || 'Sin tipo' }}
          </p>
        </ion-col>

        <!-- Estado -->
        <ion-col class="td-center">
          {{ r.state }}
        </ion-col>

        <!-- Vehículo -->
        <ion-col class="td-center">
          <ng-container *ngIf="r.vehicle; else noVehicle">
            {{ r.vehicle.brand }} - {{ r.vehicle.matricula }}
          </ng-container>
          <ng-template #noVehicle>Sin vehículo</ng-template>
        </ion-col>

        <!-- Trabajadores (chips) -->
        <ion-col class="td-center">
          <ion-chip *ngFor="let u of r.users">
            <ion-label>{{ u.name }}</ion-label>
          </ion-chip>
        </ion-col>

        <!-- Acciones -->
        <ion-col class="td-center" size="2">
          <ion-button size="small" (click)="editarRuta(r._id)">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button size="small" color="danger" (click)="eliminarRuta(r._id)">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

</ion-content>
