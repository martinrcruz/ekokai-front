<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ isEdit ? 'Editar Parte' : 'Nuevo Parte' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="page-container">
    <div class="header">
      <h1>{{ isEdit ? 'Editar Parte' : 'Nuevo Parte' }}</h1>
    </div>

    <form [formGroup]="parteForm" (ngSubmit)="onSave()" class="form-container">
      <div class="form-section">
        <h2>Información Básica</h2>
        <ion-item>
          <ion-label position="stacked">Descripción</ion-label>
          <ion-textarea 
            formControlName="description"
            rows="4"
            placeholder="Describa el trabajo a realizar">
          </ion-textarea>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Facturación (€)</ion-label>
          <ion-input 
            formControlName="facturacion" 
            type="number"
            placeholder="Importe en euros">
          </ion-input>
        </ion-item>
      </div>

      <div class="form-section">
        <h2>Clasificación</h2>
        <ion-item>
          <ion-label position="stacked">Estado</ion-label>
          <ion-select formControlName="state" placeholder="Seleccione estado">
            <ion-select-option value="Pendiente">Pendiente</ion-select-option>
            <ion-select-option value="EnProceso">En Proceso</ion-select-option>
            <ion-select-option value="Finalizado">Finalizado</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Tipo</ion-label>
          <ion-select formControlName="type" placeholder="Seleccione tipo">
            <ion-select-option value="Obra">Obra</ion-select-option>
            <ion-select-option value="Mantenimiento">Mantenimiento</ion-select-option>
            <ion-select-option value="Correctivo">Correctivo</ion-select-option>
            <ion-select-option value="Visitas">Visitas</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Categoría</ion-label>
          <ion-select formControlName="categoria" placeholder="Seleccione categoría">
            <ion-select-option value="Extintores">Extintores</ion-select-option>
            <ion-select-option value="Incendio">Incendio</ion-select-option>
            <ion-select-option value="Robo">Robo</ion-select-option>
            <ion-select-option value="CCTV">CCTV</ion-select-option>
            <ion-select-option value="Pasiva">Pasiva</ion-select-option>
            <ion-select-option value="Venta">Venta</ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <div class="form-section">
        <h2>Planificación</h2>
        <ion-item>
          <ion-label position="stacked">Fecha</ion-label>
          <ion-datetime 
            formControlName="date"
            [min]="minDate"
            display-format="yyyy-MM-dd"
            picker-format="yyyy-MM-dd"
            placeholder="Seleccione una fecha">
          </ion-datetime>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Cliente</ion-label>
          <ion-input
            placeholder="Buscar cliente..."
            [(ngModel)]="searchClientTxt"
            [ngModelOptions]="{standalone: true}"
            (ionInput)="filterCustomers($event)"
            (click)="openClientModal()"
            readonly>
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Ruta</ion-label>
          <ion-select formControlName="ruta" placeholder="Seleccione ruta">
            <ion-select-option *ngFor="let r of rutasDisponibles" [value]="r._id">
              {{ r.name?.name }} - {{ r.date | date:'shortDate' }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <div class="form-section">
        <h2>Detalles Adicionales</h2>
        <ion-item>
          <ion-label position="stacked">Coordinación</ion-label>
          <ion-select formControlName="coordinationMethod" placeholder="Método de coordinación">
            <ion-select-option value="Llamar antes">Llamar antes</ion-select-option>
            <ion-select-option value="Coordinar por email">Coordinar por email</ion-select-option>
            <ion-select-option value="Coordinar según horarios">Coordinar según horarios</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Gestiona (Nº)</ion-label>
          <ion-input 
            formControlName="gestiona" 
            type="number"
            placeholder="Número de gestión">
          </ion-input>
        </ion-item>
      </div>

      <div class="form-section">
        <h2>Artículos</h2>
        <div formArrayName="articulos">
          <div *ngFor="let articulo of articulosFormArray.controls; let i = index" [formGroupName]="i" class="articulo-item">
            <ion-item>
              <ion-label position="stacked">Cantidad</ion-label>
              <ion-input formControlName="cantidad" type="number" placeholder="Cantidad"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Código</ion-label>
              <ion-input formControlName="codigo" type="text" placeholder="Código"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Grupo</ion-label>
              <ion-input formControlName="grupo" type="text" placeholder="Grupo"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Familia</ion-label>
              <ion-input formControlName="familia" type="text" placeholder="Familia"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Descripción Artículo</ion-label>
              <ion-textarea formControlName="descripcionArticulo" placeholder="Descripción del artículo"></ion-textarea>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Precio Venta</ion-label>
              <ion-input formControlName="precioVenta" type="number" placeholder="Precio de venta"></ion-input>
            </ion-item>

            <ion-button fill="clear" color="danger" (click)="eliminarArticulo(i)">
              <ion-icon name="trash-outline"></ion-icon>
              Eliminar
            </ion-button>
          </div>
        </div>

        <ion-button expand="block" fill="outline" (click)="agregarArticulo()">
          <ion-icon name="add-outline"></ion-icon>
          Agregar Artículo
        </ion-button>
      </div>

      <div class="form-actions">
        <ion-button expand="block" type="submit" [disabled]="parteForm.invalid">
          {{ isEdit ? 'Actualizar' : 'Crear' }}
        </ion-button>
        <ion-button expand="block" fill="outline" (click)="cancel()">
          Cancelar
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>

<ion-modal [isOpen]="clientModalOpen" (ionModalDidDismiss)="closeClientModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Seleccionar Cliente</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="clientModalOpen = false">Cerrar</ion-button>
        </ion-buttons>
      </ion-toolbar>
      <ion-toolbar>
        <ion-searchbar placeholder="Buscar..." [(ngModel)]="searchClientTxt" (ionInput)="filterCustomers($event)"></ion-searchbar>
      </ion-toolbar>
    </ion-header>
    <ion-content class="modal-content">
      <ion-list>
        <ion-item button *ngFor="let c of filteredCustomers" (click)="selectCustomer(c)">
          {{ c.name }} ({{ c.nifCif }})
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>